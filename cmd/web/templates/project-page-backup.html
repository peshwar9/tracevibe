<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - TraceVibe</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f8fafc; color: #1e293b; line-height: 1.6; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 700; }
        .nav { display: flex; gap: 2rem; }
        .nav a { color: white; text-decoration: none; opacity: 0.9; transition: opacity 0.2s; }
        .nav a:hover { opacity: 1; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .card-header { background: #f1f5f9; padding: 1rem 1.5rem; border-bottom: 1px solid #e2e8f0; }
        .card-title { font-size: 1.25rem; font-weight: 600; color: #1e293b; }
        .card-content { padding: 1.5rem; }
        .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
        .badge-success { background-color: #dcfce7; color: #166534; }
        .badge-warning { background-color: #fef3c7; color: #92400e; }
        .badge-info { background-color: #dbeafe; color: #1e40af; }
        .breadcrumb { display: flex; gap: 0.5rem; margin-bottom: 1rem; color: #6b7280; }
        .breadcrumb a { color: #3b82f6; text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 700; color: #3b82f6; }
        .stat-label { color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; }
        .tree { list-style: none; padding-left: 0; }
        .tree li { margin: 0.5rem 0; }
        .tree .tree { padding-left: 2rem; border-left: 1px solid #e2e8f0; margin-left: 1rem; }
        .tree-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 4px; transition: background-color 0.2s; }
        .tree-item:hover { background-color: #f1f5f9; }
        .tree-toggle { width: 1rem; height: 1rem; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.75rem; color: #6b7280; }

        /* Accordion styles */
        .accordion { border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .accordion-item { border-bottom: 1px solid #e2e8f0; }
        .accordion-item:last-child { border-bottom: none; }
        .accordion-header {
            background: #f8fafc;
            padding: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background-color 0.2s;
            user-select: none;
        }
        .accordion-header:hover { background: #f1f5f9; }
        .accordion-header.active { background: #e0f2fe; }
        .accordion-toggle {
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        .accordion-toggle.active { background: #3b82f6; color: white; }
        .accordion-content {
            display: none;
            padding: 0;
            background: white;
        }
        .accordion-content.active { display: block; }
        .accordion-nested { padding-left: 2rem; border-left: 2px solid #e2e8f0; }

        /* Requirement type styling */
        .req-scope { border-left: 4px solid #8b5cf6; }
        .req-story { border-left: 4px solid #10b981; }
        .req-tech { border-left: 4px solid #f59e0b; }

        .req-meta {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-top: 0.25rem;
            font-size: 0.75rem;
            color: #6b7280;
        }
        .req-id { background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 3px; font-family: monospace; }
        .req-impl { margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280; }
        .impl-file { background: #f8fafc; padding: 0.25rem 0.5rem; border-radius: 3px; margin: 0.125rem 0; font-family: monospace; }
        .error { background-color: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; }
        .test-results { margin-top: 2rem; display: none; }
        .test-output { background: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 6px; font-family: 'Monaco', 'Menlo', monospace; font-size: 0.875rem; line-height: 1.5; }
        .test-summary { margin-bottom: 1rem; }
        .test-passed { color: #10b981; }
        .test-failed { color: #ef4444; }
        .run-tests-btn:hover { background: #3b82f6 !important; color: white !important; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">TraceVibe</div>
            <nav class="nav">
                <a href="/">Dashboard</a>
                <a href="/projects">Projects</a>
                <a href="/about">About</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="breadcrumb">
            <a href="/">Dashboard</a>
            <span> / </span>
            <span>{{.Project.Name}}</span>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h1 style="font-size: 2rem; font-weight: 700; color: #1e293b; margin: 0;">{{.Project.Name}}</h1>
            <a href="/export/{{.Project.ProjectKey}}"
               style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 0.5rem; transition: opacity 0.2s;"
               onmouseover="this.style.opacity='0.9'"
               onmouseout="this.style.opacity='1'"
               title="Export project details as HTML file for offline viewing">
                📄 Export HTML
            </a>
        </div>

        {{if .Error}}
        <div class="error">{{.Error}}</div>
        {{end}}

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">{{len .Components}}</div>
                <div class="stat-label">Components</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{.ScopeCount}}</div>
                <div class="stat-label">Scope Requirements</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{.UserStoryCount}}</div>
                <div class="stat-label">User Stories</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{.TechSpecCount}}</div>
                <div class="stat-label">Tech Specs</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{.TotalTestCount}}</div>
                <div class="stat-label">Test Cases</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
            <!-- Components List -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">System Components</h2>
                </div>
                <div class="card-content">
                    {{if .Components}}
                    <ul class="tree">
                        {{range .Components}}
                        <li>
                            <div class="tree-item">
                                <span class="tree-toggle">📦</span>
                                <a href="/projects/{{$.Project.ProjectKey}}/components/{{.ComponentKey}}" style="text-decoration: none; color: inherit;">
                                    <strong>{{.Name}}</strong>
                                </a>
                                <span class="badge badge-info">{{.ComponentType}}</span>
                                {{if .ScopeIDs}}
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                                    Scopes: {{range $i, $s := .ScopeIDs}}{{if $i}}, {{end}}{{$s}}{{end}}
                                </div>
                                {{end}}
                            </div>
                            <div style="margin-left: 2rem; margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                                {{.TotalRequirements}} requirements • {{.TestCaseCount}} tests
                                <button class="run-tests-btn" data-project="{{$.Project.ProjectKey}}" data-component="{{.ComponentKey}}"
                                        style="margin-left: 1rem; padding: 0.25rem 0.5rem; border: 1px solid #3b82f6; background: white;
                                               color: #3b82f6; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                    🧪 Run Tests
                                </button>
                            </div>
                        </li>
                        {{end}}
                    </ul>
                    {{else}}
                    <p style="color: #6b7280; text-align: center; padding: 2rem;">No components found.</p>
                    {{end}}
                </div>
            </div>

            <!-- Requirements Accordion -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Requirements Hierarchy</h2>
                    <span style="font-size: 0.875rem; color: #6b7280;">Click on scopes to expand user stories and tech specs</span>
                </div>
                <div class="card-content">
                    {{if .Requirements}}
                    <div class="accordion">
                        {{range .Requirements}}
                        {{if eq .RequirementType "SCOPE"}}
                        <div class="accordion-item req-scope">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div class="accordion-toggle">+</div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 1rem;">
                                        <span class="badge" style="background: #8b5cf6; color: white; margin-right: 0.5rem;">SCOPE</span>
                                        {{.Title}}
                                    </div>
                                    <div class="req-meta">
                                        <span class="req-id">{{.RequirementKey}}</span>
                                        <span class="badge {{if eq .Status "IMPLEMENTED"}}badge-success{{else if eq .Status "IN_PROGRESS"}}badge-warning{{else}}badge-info{{end}}">{{.Status}}</span>
                                        {{if .UserStoryCount}}<span style="margin-left: 0.5rem;">📖 {{.UserStoryCount}} user stories</span>{{end}}
                                        {{if .TechSpecCount}}<span style="margin-left: 0.5rem;">⚙️ {{.TechSpecCount}} tech specs</span>{{end}}
                                        {{if .TestCaseCount}}<span style="margin-left: 0.5rem;">🧪 {{.TestCaseCount}} tests</span>{{end}}
                                    </div>
                                    {{if .Description}}
                                    <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #4b5563;">{{.Description}}</div>
                                    {{end}}
                                </div>
                            </div>
                            <div class="accordion-content">
                                {{if .Children}}
                                <div style="padding: 1rem;">
                                    {{range .Children}}
                                    {{if eq .RequirementType "USER_STORY"}}
                                    <div class="accordion-item req-story" style="margin-bottom: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                                        <div class="accordion-header" onclick="toggleAccordion(this)">
                                            <div class="accordion-toggle">+</div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 500;">
                                                    <span class="badge badge-success" style="margin-right: 0.5rem;">USER STORY</span>
                                                    {{.Title}}
                                                </div>
                                                <div class="req-meta">
                                                    <span class="req-id">{{.RequirementKey}}</span>
                                                    <span class="badge {{if eq .Status "IMPLEMENTED"}}badge-success{{else if eq .Status "IN_PROGRESS"}}badge-warning{{else}}badge-info{{end}}">{{.Status}}</span>
                                                    {{if .TechSpecCount}}<span style="margin-left: 0.5rem;">⚙️ {{.TechSpecCount}} tech specs</span>{{end}}
                                                    {{if .TestCaseCount}}<span style="margin-left: 0.5rem;">🧪 {{.TestCaseCount}} tests</span>{{end}}
                                                </div>
                                                {{if .Description}}
                                                <div style="margin-top: 0.25rem; font-size: 0.8rem; color: #6b7280;">{{.Description}}</div>
                                                {{end}}
                                            </div>
                                        </div>
                                        <div class="accordion-content">
                                            {{if .Children}}
                                            <div style="padding: 0.75rem;">
                                                {{range .Children}}
                                                {{if eq .RequirementType "TECH_SPEC"}}
                                                <div class="req-tech" style="background: #fffbeb; border: 1px solid #fde68a; border-radius: 4px; padding: 0.75rem; margin-bottom: 0.5rem;">
                                                    <div style="font-weight: 500; font-size: 0.9rem;">
                                                        <span class="badge badge-warning" style="margin-right: 0.5rem;">TECH SPEC</span>
                                                        {{.Title}}
                                                    </div>
                                                    <div class="req-meta">
                                                        <span class="req-id">{{.RequirementKey}}</span>
                                                        <span class="badge {{if eq .Status "IMPLEMENTED"}}badge-success{{else if eq .Status "IN_PROGRESS"}}badge-warning{{else}}badge-info{{end}}">{{.Status}}</span>
                                                        {{if .TestCaseCount}}<span style="margin-left: 0.5rem;">🧪 {{.TestCaseCount}} tests</span>{{end}}
                                                    </div>
                                                    {{if .Description}}
                                                    <div style="margin-top: 0.25rem; font-size: 0.8rem; color: #6b7280;">{{.Description}}</div>
                                                    {{end}}
                                                    {{if .Implementation}}
                                                    <div class="req-impl">
                                                        <strong>Implementation:</strong>
                                                        {{range .Implementation}}
                                                        <div class="impl-file">📁 {{.FilePath}}{{if .Functions}} → {{range $i, $f := .Functions}}{{if $i}}, {{end}}{{$f}}{{end}}{{end}}</div>
                                                        {{end}}
                                                    </div>
                                                    {{end}}
                                                    {{if .TestCases}}
                                                    <div class="req-impl">
                                                        <strong>Tests:</strong>
                                                        {{range .TestCases}}
                                                        <div class="impl-file">🧪 {{.FilePath}} → {{.TestName}}</div>
                                                        {{end}}
                                                    </div>
                                                    {{end}}
                                                </div>
                                                {{end}}
                                                {{end}}
                                            </div>
                                            {{else}}
                                            <div style="padding: 0.75rem; color: #6b7280; font-style: italic;">No tech specs defined</div>
                                            {{end}}
                                        </div>
                                    </div>
                                    {{end}}
                                    {{end}}
                                </div>
                                {{else}}
                                <div style="padding: 1rem; color: #6b7280; font-style: italic;">No user stories defined</div>
                                {{end}}
                            </div>
                        </div>
                        {{end}}
                        {{end}}
                    </div>
                    {{else}}
                    <p style="color: #6b7280; text-align: center; padding: 2rem;">No requirements found.</p>
                    {{end}}
                </div>
            </div>
        </div>

        <!-- Project Info -->
        <div class="card" style="margin-top: 2rem;">
            <div class="card-header">
                <h2 class="card-title">Project Information</h2>
            </div>
            <div class="card-content">
                <dl style="display: grid; grid-template-columns: 200px 1fr; gap: 1rem;">
                    <dt style="font-weight: 600; color: #374151;">Project Key:</dt>
                    <dd>{{.Project.ProjectKey}}</dd>

                    <dt style="font-weight: 600; color: #374151;">Name:</dt>
                    <dd>{{.Project.Name}}</dd>

                    {{if .Project.Description}}
                    <dt style="font-weight: 600; color: #374151;">Description:</dt>
                    <dd>{{.Project.Description}}</dd>
                    {{end}}

                    {{if .Project.RepositoryURL}}
                    <dt style="font-weight: 600; color: #374151;">Repository:</dt>
                    <dd><a href="{{.Project.RepositoryURL}}" target="_blank" style="color: #3b82f6;">{{.Project.RepositoryURL}}</a></dd>
                    {{end}}

                    <dt style="font-weight: 600; color: #374151;">Status:</dt>
                    <dd><span class="badge badge-success">{{.Project.Status}}</span></dd>

                    <dt style="font-weight: 600; color: #374151;">Created:</dt>
                    <dd>{{.Project.CreatedAt}}</dd>
                </dl>
            </div>
        </div>

        <!-- Test Results Section -->
        <div id="testResults" class="test-results">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Test Results</h2>
                    <span id="testStatus" style="font-size: 0.875rem; color: #6b7280;">Ready</span>
                </div>
                <div class="card-content">
                    <div id="testSummary" class="test-summary"></div>
                    <div id="testOutput" class="test-output"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Toggle accordion items
        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const toggle = header.querySelector('.accordion-toggle');
            const isActive = content.classList.contains('active');

            if (isActive) {
                content.classList.remove('active');
                header.classList.remove('active');
                toggle.classList.remove('active');
                toggle.textContent = '+';
            } else {
                content.classList.add('active');
                header.classList.add('active');
                toggle.classList.add('active');
                toggle.textContent = '−';
            }
        }

        // Toggle tree items (for components)
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('tree-toggle')) {
                const treeItem = e.target.closest('li');
                const childTree = treeItem.querySelector('.tree');
                if (childTree) {
                    childTree.style.display = childTree.style.display === 'none' ? 'block' : 'none';
                    e.target.textContent = childTree.style.display === 'none' ? '▶' : '▼';
                }
            }
        });

        // Handle run tests button clicks
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('run-tests-btn')) {
                const project = e.target.dataset.project;
                const component = e.target.dataset.component;
                runTests(project, component, e.target);
            }
        });

        async function runTests(project, component, button) {
            const testResults = document.getElementById('testResults');
            const testStatus = document.getElementById('testStatus');
            const testSummary = document.getElementById('testSummary');
            const testOutput = document.getElementById('testOutput');

            // Show test results section
            testResults.style.display = 'block';
            testResults.scrollIntoView({ behavior: 'smooth' });

            // Update button state
            button.disabled = true;
            button.textContent = '⏳ Running...';
            testStatus.textContent = 'Running tests...';
            testOutput.textContent = 'Starting test execution...\n';

            try {
                const response = await fetch(`/api/test/run`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        project: project,
                        component: component
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Update test summary
                const passed = result.passed || 0;
                const failed = result.failed || 0;
                const total = passed + failed;

                testSummary.innerHTML = `
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <span>Total: ${total}</span>
                        <span class="test-passed">✓ Passed: ${passed}</span>
                        ${failed > 0 ? `<span class="test-failed">✗ Failed: ${failed}</span>` : ''}
                        <span>Duration: ${result.duration || 'N/A'}</span>
                    </div>
                `;

                // Update test output
                testOutput.textContent = result.output || 'Test execution completed.';
                testStatus.textContent = failed > 0 ? 'Tests failed' : 'All tests passed';
                testStatus.className = failed > 0 ? 'test-failed' : 'test-passed';

            } catch (error) {
                testSummary.innerHTML = '<span class="test-failed">Error running tests</span>';
                testOutput.textContent = `Error: ${error.message}`;
                testStatus.textContent = 'Error occurred';
                testStatus.className = 'test-failed';
            } finally {
                // Reset button state
                button.disabled = false;
                button.textContent = '🧪 Run Tests';
            }
        }
    </script>
</body>
</html>