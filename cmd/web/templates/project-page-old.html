<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Project.Name}} - TraceVibe</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f8fafc; color: #1e293b; line-height: 1.6; }

        /* Header Styles */
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 700; }
        .nav { display: flex; gap: 2rem; }
        .nav a { color: white; text-decoration: none; opacity: 0.9; transition: opacity 0.2s; }
        .nav a:hover { opacity: 1; }

        /* Container & Layout */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .breadcrumb { margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem; }
        .breadcrumb a { color: #3b82f6; text-decoration: none; }

        /* Cards */
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
        .card-header { background: #f1f5f9; padding: 1rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 1.25rem; font-weight: 600; color: #1e293b; }
        .card-content { padding: 1.5rem; }

        /* Buttons */
        .btn { display: inline-block; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-weight: 500; transition: all 0.2s; border: none; cursor: pointer; font-size: 0.875rem; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover { background-color: #059669; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover { background-color: #d97706; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }

        /* Badges */
        .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
        .badge-success { background-color: #dcfce7; color: #166534; }
        .badge-warning { background-color: #fef3c7; color: #92400e; }
        .badge-info { background-color: #dbeafe; color: #1e40af; }

        /* Requirements Tree */
        .requirements-tree { margin-top: 1rem; }
        .accordion { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem; overflow: hidden; }
        .accordion-header { padding: 1rem; background: #f9fafb; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        .accordion-header:hover { background-color: #f3f4f6; }
        .accordion-header.active { background-color: #e5e7eb; }
        .accordion-toggle { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: #e5e7eb; border-radius: 4px; font-weight: bold; transition: all 0.2s; }
        .accordion-toggle.active { background: #3b82f6; color: white; transform: rotate(180deg); }
        .accordion-content { display: none; background: white; }
        .accordion-content.active { display: block; }

        /* Edit/Delete Actions */
        .req-actions { display: flex; gap: 0.25rem; margin-left: auto; }
        .req-header { display: flex; align-items: center; gap: 1rem; }
        .req-info { flex: 1; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: white; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.5rem; }

        /* Form Styles */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .form-control { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem; }
        .form-control:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        textarea.form-control { min-height: 100px; resize: vertical; }

        /* Inline Edit */
        .description-edit { display: none; }
        .description-edit.active { display: block; }
        .description-view { cursor: pointer; padding: 0.25rem; border: 1px solid transparent; border-radius: 4px; }
        .description-view:hover { background-color: #f9fafb; border-color: #e5e7eb; }
        .description-view.editing { display: none; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">TraceVibe</div>
            <nav class="nav">
                <a href="/">Dashboard</a>
                <a href="/projects">Projects</a>
                <a href="/about">About</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="breadcrumb">
            <a href="/">Dashboard</a> /
            <a href="/projects">Projects</a> /
            <span>{{.Project.Name}}</span>
        </div>

        <!-- Project Header with Export Button -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h1 style="font-size: 2rem; font-weight: 700; color: #1e293b; margin: 0;">{{.Project.Name}}</h1>
            <div style="display: flex; gap: 0.5rem;">
                <a href="/export/{{.Project.ProjectKey}}" class="btn btn-primary" title="Export as HTML">ðŸ“„ Export HTML</a>
                <button onclick="showAddScopeModal()" class="btn btn-success">+ Add Scope</button>
            </div>
        </div>

        {{if .Project.Description}}
        <p style="color: #6b7280; margin-bottom: 2rem;">{{.Project.Description}}</p>
        {{end}}

        <!-- Components and Requirements -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Requirements by Component</h2>
            </div>
            <div class="card-content">
                <div class="requirements-tree">
                    {{if .Requirements}}
                    <div>
                        {{range .Requirements}}
                        {{if eq .RequirementType "SCOPE"}}
                        <div class="accordion" data-requirement-id="{{.ID}}">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div class="req-header">
                                    <div class="req-info">
                                        <div style="font-weight: 600;">
                                            <span class="badge badge-info" style="margin-right: 0.5rem;">SCOPE</span>
                                            {{.Title}}
                                        </div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                            <span>ID: {{.RequirementKey}}</span>
                                            <span style="margin-left: 1rem;">Status: {{.Status}}</span>
                                            <span style="margin-left: 1rem;">Priority: {{.Priority}}</span>
                                        </div>
                                        <div class="description-view" onclick="event.stopPropagation(); editDescription('{{.ID}}', this)">
                                            {{if .Description}}{{.Description}}{{else}}<em style="color: #9ca3af;">Click to add description</em>{{end}}
                                        </div>
                                        <div class="description-edit" data-req-id="{{.ID}}">
                                            <textarea class="form-control" style="margin-top: 0.5rem;">{{.Description}}</textarea>
                                            <div style="margin-top: 0.5rem;">
                                                <button class="btn btn-sm btn-primary" onclick="saveDescription('{{.ID}}')">Save</button>
                                                <button class="btn btn-sm" onclick="cancelEdit('{{.ID}}')">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="req-actions">
                                        <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); showAddUserStoryModal('{{.ID}}', '{{.RequirementKey}}')">+ Story</button>
                                        <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteRequirement('{{.ID}}', 'scope')">Delete</button>
                                    </div>
                                </div>
                                <div class="accordion-toggle">+</div>
                            </div>
                            <div class="accordion-content">
                                {{if .Children}}
                                <div style="padding: 1rem;">
                                    {{range .Children}}
                                    {{if eq .RequirementType "USER_STORY"}}
                                    <div class="accordion" style="margin-bottom: 0.75rem;" data-requirement-id="{{.ID}}">
                                        <div class="accordion-header" onclick="toggleAccordion(this)" style="background: #f0f9ff;">
                                            <div class="req-header">
                                                <div class="req-info">
                                                    <div style="font-weight: 500;">
                                                        <span class="badge badge-success" style="margin-right: 0.5rem;">USER STORY</span>
                                                        {{.Title}}
                                                    </div>
                                                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                                        <span>ID: {{.RequirementKey}}</span>
                                                        <span style="margin-left: 1rem;">Status: {{.Status}}</span>
                                                    </div>
                                                    <div class="description-view" onclick="event.stopPropagation(); editDescription('{{.ID}}', this)">
                                                        {{if .Description}}{{.Description}}{{else}}<em style="color: #9ca3af;">Click to add description</em>{{end}}
                                                    </div>
                                                    <div class="description-edit" data-req-id="{{.ID}}">
                                                        <textarea class="form-control" style="margin-top: 0.5rem;">{{.Description}}</textarea>
                                                        <div style="margin-top: 0.5rem;">
                                                            <button class="btn btn-sm btn-primary" onclick="saveDescription('{{.ID}}')">Save</button>
                                                            <button class="btn btn-sm" onclick="cancelEdit('{{.ID}}')">Cancel</button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="req-actions">
                                                    <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); showAddTechSpecModal('{{.ID}}', '{{.RequirementKey}}')">+ Tech Spec</button>
                                                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteRequirement('{{.ID}}', 'user story')">Delete</button>
                                                </div>
                                            </div>
                                            <div class="accordion-toggle">+</div>
                                        </div>
                                        <div class="accordion-content">
                                            {{if .Children}}
                                            <div style="padding: 0.75rem;">
                                                {{range .Children}}
                                                {{if eq .RequirementType "TECH_SPEC"}}
                                                <div style="background: #fffbeb; border: 1px solid #fde68a; border-radius: 4px; padding: 0.75rem; margin-bottom: 0.5rem;" data-requirement-id="{{.ID}}">
                                                    <div class="req-header">
                                                        <div class="req-info">
                                                            <div style="font-weight: 500; font-size: 0.9rem;">
                                                                <span class="badge badge-warning" style="margin-right: 0.5rem;">TECH SPEC</span>
                                                                {{.Title}}
                                                            </div>
                                                            <div style="font-size: 0.8rem; color: #6b7280;">
                                                                <span>ID: {{.RequirementKey}}</span>
                                                                <span style="margin-left: 0.5rem;">Status: {{.Status}}</span>
                                                            </div>
                                                            <div class="description-view" onclick="editDescription('{{.ID}}', this)">
                                                                {{if .Description}}{{.Description}}{{else}}<em style="color: #9ca3af;">Click to add description</em>{{end}}
                                                            </div>
                                                            <div class="description-edit" data-req-id="{{.ID}}">
                                                                <textarea class="form-control" style="margin-top: 0.5rem;">{{.Description}}</textarea>
                                                                <div style="margin-top: 0.5rem;">
                                                                    <button class="btn btn-sm btn-primary" onclick="saveDescription('{{.ID}}')">Save</button>
                                                                    <button class="btn btn-sm" onclick="cancelEdit('{{.ID}}')">Cancel</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="req-actions">
                                                            <button class="btn btn-sm btn-danger" onclick="deleteRequirement('{{.ID}}', 'tech spec')">Delete</button>
                                                        </div>
                                                    </div>
                                                </div>
                                                {{end}}
                                                {{end}}
                                            </div>
                                            {{else}}
                                            <div style="padding: 0.75rem; color: #6b7280; font-style: italic;">No tech specs defined</div>
                                            {{end}}
                                        </div>
                                    </div>
                                    {{end}}
                                    {{end}}
                                </div>
                                {{else}}
                                <div style="padding: 1rem; color: #6b7280; font-style: italic;">No user stories defined</div>
                                {{end}}
                            </div>
                        </div>
                        {{end}}
                        {{end}}
                    </div>
                    {{else}}
                    <p style="color: #6b7280; text-align: center; padding: 2rem;">No requirements found. Click "Add Scope" to get started!</p>
                    {{end}}
                </div>
            </div>
        </div>
    </main>

    <!-- Add Scope Modal -->
    <div id="addScopeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Scope</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="scopeTitle" class="form-control" placeholder="Enter scope title">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="scopeDescription" class="form-control" placeholder="Enter scope description"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select id="scopeCategory" class="form-control">
                        <option value="backend_api">Backend API</option>
                        <option value="frontend_ui">Frontend UI</option>
                        <option value="database">Database</option>
                        <option value="security">Security</option>
                        <option value="infrastructure">Infrastructure</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select id="scopePriority" class="form-control">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('addScopeModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addScope()">Add Scope</button>
            </div>
        </div>
    </div>

    <!-- Add User Story Modal -->
    <div id="addUserStoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New User Story</h2>
                <p style="color: #6b7280; margin-top: 0.5rem;">Parent Scope: <span id="parentScopeKey"></span></p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="storyTitle" class="form-control" placeholder="As a user, I want to...">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="storyDescription" class="form-control" placeholder="Enter user story description"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select id="storyPriority" class="form-control">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('addUserStoryModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addUserStory()">Add User Story</button>
            </div>
        </div>
    </div>

    <!-- Add Tech Spec Modal -->
    <div id="addTechSpecModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Tech Spec</h2>
                <p style="color: #6b7280; margin-top: 0.5rem;">Parent User Story: <span id="parentStoryKey"></span></p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="specTitle" class="form-control" placeholder="Enter technical specification">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="specDescription" class="form-control" placeholder="Enter technical details"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select id="specPriority" class="form-control">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('addTechSpecModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addTechSpec()">Add Tech Spec</button>
            </div>
        </div>
    </div>

    <script>
        // Project data from server
        const projectData = {
            projectId: '{{.Project.ID}}',
            projectKey: '{{.Project.ProjectKey}}',
            componentId: '{{if .Component}}{{.Component.ID}}{{end}}'
        };

        // Modal functions
        function showAddScopeModal() {
            document.getElementById('addScopeModal').classList.add('active');
        }

        function showAddUserStoryModal(parentId, parentKey) {
            document.getElementById('addUserStoryModal').classList.add('active');
            document.getElementById('parentScopeKey').textContent = parentKey;
            document.getElementById('addUserStoryModal').dataset.parentId = parentId;
        }

        function showAddTechSpecModal(parentId, parentKey) {
            document.getElementById('addTechSpecModal').classList.add('active');
            document.getElementById('parentStoryKey').textContent = parentKey;
            document.getElementById('addTechSpecModal').dataset.parentId = parentId;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Clear form fields
            const modal = document.getElementById(modalId);
            modal.querySelectorAll('input, textarea').forEach(input => input.value = '');
        }

        // Toggle accordion
        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const toggle = header.querySelector('.accordion-toggle');
            const isActive = content.classList.contains('active');

            if (isActive) {
                content.classList.remove('active');
                header.classList.remove('active');
                toggle.classList.remove('active');
                toggle.textContent = '+';
            } else {
                content.classList.add('active');
                header.classList.add('active');
                toggle.classList.add('active');
                toggle.textContent = 'âˆ’';
            }
        }

        // Edit description inline
        function editDescription(reqId, viewElement) {
            viewElement.classList.add('editing');
            const editDiv = viewElement.nextElementSibling;
            editDiv.classList.add('active');
            editDiv.querySelector('textarea').focus();
        }

        function cancelEdit(reqId) {
            const editDiv = document.querySelector(`.description-edit[data-req-id="${reqId}"]`);
            const viewDiv = editDiv.previousElementSibling;
            editDiv.classList.remove('active');
            viewDiv.classList.remove('editing');
        }

        async function saveDescription(reqId) {
            const editDiv = document.querySelector(`.description-edit[data-req-id="${reqId}"]`);
            const viewDiv = editDiv.previousElementSibling;
            const description = editDiv.querySelector('textarea').value;

            try {
                const response = await fetch(`/api/requirements/${reqId}/description`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description })
                });

                if (response.ok) {
                    viewDiv.innerHTML = description || '<em style="color: #9ca3af;">Click to add description</em>';
                    editDiv.classList.remove('active');
                    viewDiv.classList.remove('editing');
                } else {
                    alert('Failed to update description');
                }
            } catch (error) {
                alert('Error updating description: ' + error.message);
            }
        }

        // Add new scope
        async function addScope() {
            const title = document.getElementById('scopeTitle').value;
            const description = document.getElementById('scopeDescription').value;
            const category = document.getElementById('scopeCategory').value;
            const priority = document.getElementById('scopePriority').value;

            if (!title) {
                alert('Please enter a title');
                return;
            }

            try {
                const response = await fetch('/api/requirements/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: projectData.projectId,
                        component_id: projectData.componentId || projectData.projectId,
                        requirement_type: 'scope',
                        title,
                        description: description || null,
                        category,
                        priority,
                        status: 'not_started'
                    })
                });

                if (response.ok) {
                    closeModal('addScopeModal');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Failed to create scope: ' + error);
                }
            } catch (error) {
                alert('Error creating scope: ' + error.message);
            }
        }

        // Add new user story
        async function addUserStory() {
            const modal = document.getElementById('addUserStoryModal');
            const parentId = modal.dataset.parentId;
            const title = document.getElementById('storyTitle').value;
            const description = document.getElementById('storyDescription').value;
            const priority = document.getElementById('storyPriority').value;

            if (!title) {
                alert('Please enter a title');
                return;
            }

            try {
                const response = await fetch('/api/requirements/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: projectData.projectId,
                        component_id: projectData.componentId || projectData.projectId,
                        parent_requirement_id: parentId,
                        requirement_type: 'user_story',
                        title,
                        description: description || null,
                        category: 'feature',
                        priority,
                        status: 'not_started'
                    })
                });

                if (response.ok) {
                    closeModal('addUserStoryModal');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Failed to create user story: ' + error);
                }
            } catch (error) {
                alert('Error creating user story: ' + error.message);
            }
        }

        // Add new tech spec
        async function addTechSpec() {
            const modal = document.getElementById('addTechSpecModal');
            const parentId = modal.dataset.parentId;
            const title = document.getElementById('specTitle').value;
            const description = document.getElementById('specDescription').value;
            const priority = document.getElementById('specPriority').value;

            if (!title) {
                alert('Please enter a title');
                return;
            }

            try {
                const response = await fetch('/api/requirements/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: projectData.projectId,
                        component_id: projectData.componentId || projectData.projectId,
                        parent_requirement_id: parentId,
                        requirement_type: 'tech_spec',
                        title,
                        description: description || null,
                        category: 'technical',
                        priority,
                        status: 'not_started'
                    })
                });

                if (response.ok) {
                    closeModal('addTechSpecModal');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Failed to create tech spec: ' + error);
                }
            } catch (error) {
                alert('Error creating tech spec: ' + error.message);
            }
        }

        // Delete requirement
        async function deleteRequirement(reqId, reqType) {
            if (!confirm(`Are you sure you want to delete this ${reqType}? This will also delete all child requirements.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/requirements/${reqId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Failed to delete requirement: ' + error);
                }
            } catch (error) {
                alert('Error deleting requirement: ' + error.message);
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>