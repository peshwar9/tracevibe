<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Project.Name}} - TraceVibe</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f8fafc; color: #1e293b; line-height: 1.6; }

        /* Header Styles */
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 700; }
        .nav { display: flex; gap: 2rem; }
        .nav a { color: white; text-decoration: none; opacity: 0.9; transition: opacity 0.2s; }
        .nav a:hover { opacity: 1; }

        /* Container & Layout */
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .breadcrumb { margin-bottom: 1rem; color: #6b7280; font-size: 0.875rem; }
        .breadcrumb a { color: #3b82f6; text-decoration: none; }

        /* Cards */
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 2rem; }
        .card-header { background: #f1f5f9; padding: 1rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 1.25rem; font-weight: 600; color: #1e293b; }
        .card-content { padding: 1.5rem; }

        /* Buttons */
        .btn { display: inline-block; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-weight: 500; transition: all 0.2s; border: none; cursor: pointer; font-size: 0.875rem; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover { background-color: #059669; }
        .btn-warning { background-color: #f59e0b; color: white; }
        .btn-warning:hover { background-color: #d97706; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }

        /* Badges */
        .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; }
        .badge-success { background-color: #dcfce7; color: #166534; }
        .badge-warning { background-color: #fef3c7; color: #92400e; }
        .badge-info { background-color: #dbeafe; color: #1e40af; }

        /* Requirements Tree */
        .requirements-tree { margin-top: 1rem; }
        .accordion { border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem; overflow: hidden; }
        .accordion-header { padding: 1rem; background: #f9fafb; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        .accordion-header:hover { background-color: #f3f4f6; }
        .accordion-header.active { background-color: #e5e7eb; }
        .accordion-toggle { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: #e5e7eb; border-radius: 4px; font-weight: bold; transition: all 0.2s; }
        .accordion-toggle.active { background: #3b82f6; color: white; }
        .accordion-content { display: none; background: white; }
        .accordion-content.active { display: block; }

        /* Component Accordion */
        .component-accordion { border: 1px solid #d1d5db; border-radius: 8px; margin-bottom: 1.5rem; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .component-header { padding: 1.5rem; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; border-bottom: 1px solid #e2e8f0; }
        .component-header:hover { background: linear-gradient(135deg, #f1f5f9 0%, #d1d5db 100%); }
        .component-header.active { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-bottom-color: #3b82f6; }
        .component-toggle { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: #e5e7eb; border-radius: 6px; font-weight: bold; transition: all 0.2s; font-size: 1.2rem; }
        .component-toggle.active { background: #3b82f6; color: white; }
        .component-content { display: none; background: white; padding: 0; }
        .component-content.active { display: block; }

        /* Edit/Delete Actions */
        .req-actions { display: flex; gap: 0.25rem; margin-left: auto; }
        .req-header { display: flex; align-items: center; gap: 1rem; }
        .req-info { flex: 1; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: white; border-radius: 8px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.5rem; }

        /* Form Styles */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151; }
        .form-control { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1rem; }
        .form-control:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        textarea.form-control { min-height: 100px; resize: vertical; }

        /* Inline Edit */
        .description-edit { display: none; }
        .description-edit.active { display: block; }
        .description-view { cursor: pointer; padding: 0.25rem; border: 1px solid transparent; border-radius: 4px; }
        .description-view:hover { background-color: #f9fafb; border-color: #e5e7eb; }
        .description-view.editing { display: none; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">TraceVibe</div>
            <nav class="nav">
                <a href="/">Dashboard</a>
                <a href="/projects">Projects</a>
                <a href="/about">About</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="breadcrumb">
            <a href="/">Dashboard</a> /
            <a href="/projects">Projects</a> /
            <span>{{.Project.Name}}</span>
        </div>

        <!-- Project Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h1 style="font-size: 2rem; font-weight: 700; color: #1e293b; margin: 0;">{{.Project.Name}}</h1>
            <div style="display: flex; gap: 0.5rem;">
                <!-- Project Context Button -->
                <button onclick="showProjectContextModal()" class="btn" style="background-color: #8b5cf6; color: white;" title="Edit Project Context for Code Gen Prompts">
                    üìù Project Context
                </button>

                <!-- Add Component Button (shown when components exist) -->
                {{if .ComponentsWithReqs}}
                <button onclick="showAddComponentModal()" class="btn btn-success">
                    üèóÔ∏è Add Component
                </button>
                {{end}}

                <!-- Export Dropdown -->
                <div style="position: relative; display: inline-block;">
                    <button onclick="toggleExportDropdown()" class="btn btn-primary" style="display: flex; align-items: center; gap: 0.5rem;">
                        üì§ Export
                        <span style="font-size: 0.75rem;">‚ñº</span>
                    </button>
                    <div id="exportDropdown" style="display: none; position: absolute; right: 0; top: 100%; background: white; min-width: 200px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 6px; border: 1px solid #e5e7eb; z-index: 1000; margin-top: 0.25rem;">
                        <div style="padding: 0.5rem 0;">
                            <a href="/export/{{.Project.ProjectKey}}" style="display: block; padding: 0.75rem 1rem; color: #374151; text-decoration: none; border-bottom: 1px solid #f3f4f6;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                                üìÑ HTML Report
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">Interactive web report</div>
                            </a>
                            <a href="/export-json/{{.Project.ProjectKey}}" style="display: block; padding: 0.75rem 1rem; color: #374151; text-decoration: none; border-bottom: 1px solid #f3f4f6;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                                ü§ñ JSON Export
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">For LLM consumption</div>
                            </a>
                            <a href="/export-yaml/{{.Project.ProjectKey}}" style="display: block; padding: 0.75rem 1rem; color: #374151; text-decoration: none; border-bottom: 1px solid #f3f4f6;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                                üìã YAML Export
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">For LLM consumption</div>
                            </a>
                            <a href="/export-markdown/{{.Project.ProjectKey}}" style="display: block; padding: 0.75rem 1rem; color: #374151; text-decoration: none;" onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='white'">
                                üìù Markdown Export
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">For human/dev consumption</div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {{if .Error}}
        <div style="background-color: #fef2f2; border: 1px solid #fecaca; color: #dc2626; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">{{.Error}}</div>
        {{end}}

        {{if .Project.Description}}
        <p style="color: #6b7280; margin-bottom: 2rem;">{{if .Project.Description}}{{.Project.Description}}{{else}}No description available.{{end}}</p>
        {{end}}

        <!-- Tags Filter -->
        {{if .ComponentsWithReqs}}
        <div class="card" style="margin-bottom: 1rem;">
            <div class="card-content" style="padding: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <span style="font-weight: 600; color: #1e293b;">Filter by tags:</span>
                    <div id="tagFilters" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <!-- Tags will be populated by JavaScript -->
                    </div>
                    <span id="componentCounter" style="color: #6b7280; font-size: 0.875rem; font-weight: 500;">
                        <!-- Component count will be updated by JavaScript -->
                    </span>
                    <button class="btn btn-sm" onclick="clearTagFilters()" style="background-color: #6b7280; color: white;">Clear All</button>
                </div>
            </div>
        </div>
        {{end}}

        <!-- Components and Requirements -->
        {{if .ComponentsWithReqs}}
        {{range .ComponentsWithReqs}}
        <div class="component-accordion" data-component-tags="{{range $i, $tag := .Tags}}{{if $i}},{{end}}{{$tag}}{{end}}">
            <div class="component-header" onclick="toggleComponentAccordion(this)">
                <div>
                    <h2 style="font-size: 1.5rem; font-weight: 700; color: #1e293b; margin: 0;">{{.Name}}</h2>
                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                        {{.ComponentType}} Component | Technology: {{if .Technology}}{{.Technology}}{{else}}N/A{{end}}
                    </div>
                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                        Scopes: {{.ScopeCount}} | User Stories: {{.UserStoryCount}} | Tech Specs: {{.TechSpecCount}} | Test Cases: {{.TestCaseCount}}
                    </div>
                    {{if .Tags}}
                    <div style="font-size: 0.875rem; margin-top: 0.5rem;">
                        <span style="color: #6b7280;">Tags:</span>
                        {{range .Tags}}
                        <span class="badge" style="background-color: #e0e7ff; color: #3730a3; margin-left: 0.25rem;">{{.}}</span>
                        {{end}}
                    </div>
                    {{end}}
                    {{if .Description}}
                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">
                        <div class="description-preview" id="preview-{{.ID}}" onclick="toggleDescription('{{.ID}}')">
                            <span class="description-short">{{if gt (len .Description) 100}}{{slice .Description 0 100}}...{{else}}{{.Description}}{{end}}</span>
                            {{if gt (len .Description) 100}}<span style="color: #3b82f6; cursor: pointer; font-weight: 500;"> Show More</span>{{end}}
                        </div>
                        <div class="description-full" id="desc-{{.ID}}" style="display: none; white-space: pre-line;">{{.Description}}
                            <span onclick="toggleDescription('{{.ID}}')" style="color: #3b82f6; cursor: pointer; font-weight: 500;"> Show Less</span>
                        </div>
                    </div>
                    {{end}}
                </div>
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <button onclick="event.stopPropagation(); generateCodePrompt('component', '{{.ID}}')" class="btn btn-sm" style="background-color: #8b5cf6; color: white;" title="Generate Code Prompt for Component">ü§ñ Code Gen Prompt</button>
                    <button onclick="event.stopPropagation(); showEditComponentModal('{{.ID}}', '{{.Name}}', '{{.ComponentType}}', '{{.Technology}}', '{{.Description}}', '{{range $i, $tag := .Tags}}{{if $i}},{{end}}{{$tag}}{{end}}')" class="btn btn-primary">Edit</button>
                    <button onclick="event.stopPropagation(); showAddScopeModal('{{.ID}}')" class="btn btn-success">+ Add Scope</button>
                    <div class="component-toggle">+</div>
                </div>
            </div>
            <div class="component-content">
                <div style="padding: 1.5rem;">
                    <div class="requirements-tree">
                        {{if .Requirements}}
                        {{range .Requirements}}
                        {{if or (eq .RequirementType "SCOPE") (eq .RequirementType "scope")}}
                        <div class="accordion" data-requirement-id="{{.ID}}">
                            <div class="accordion-header" onclick="toggleAccordion(this)">
                                <div class="req-header">
                                    <div class="req-info">
                                        <div style="font-weight: 600;">
                                            <span class="badge badge-info" style="margin-right: 0.5rem;">SCOPE</span>
                                            {{.Title}}
                                        </div>
                                        <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                            <span>ID: {{.RequirementKey}}</span>
                                            <span style="margin-left: 1rem;">Status: {{.Status}}</span>
                                            <span style="margin-left: 1rem;">Priority: {{.Priority}}</span>
                                        </div>
                                        <div class="description-view" onclick="event.stopPropagation(); editDescription('{{.ID}}', this)">
                                            {{if .Description}}{{.Description}}{{else}}<em style="color: #9ca3af;">Click to add description</em>{{end}}
                                        </div>
                                        <div class="description-edit" data-req-id="{{.ID}}">
                                            <textarea class="form-control" style="margin-top: 0.5rem;">{{.Description}}</textarea>
                                            <div style="margin-top: 0.5rem;">
                                                <button class="btn btn-sm btn-primary" onclick="saveDescription('{{.ID}}')">Save</button>
                                                <button class="btn btn-sm" onclick="cancelEdit('{{.ID}}')">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="req-actions">
                                        <button onclick="event.stopPropagation(); generateCodePrompt('scope', '{{.ID}}')" class="btn btn-sm" style="background-color: #8b5cf6; color: white;" title="Generate Code Prompt for Scope">ü§ñ Code Gen Prompt</button>
                                        <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); showAddUserStoryModal('{{.ID}}', '{{.RequirementKey}}')">+ Story</button>
                                        <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteRequirement('{{.ID}}', 'scope')">Delete</button>
                                    </div>
                                </div>
                                <div class="accordion-toggle">+</div>
                            </div>
                            <div class="accordion-content">
                                {{if .Children}}
                                <div style="padding: 1rem;">
                                    {{range .Children}}
                                    {{if or (eq .RequirementType "USER_STORY") (eq .RequirementType "user_story")}}
                                    <div class="accordion" style="margin-bottom: 0.75rem;" data-requirement-id="{{.ID}}">
                                        <div class="accordion-header" onclick="toggleAccordion(this)" style="background: #f0f9ff;">
                                            <div class="req-header">
                                                <div class="req-info">
                                                    <div style="font-weight: 500;">
                                                        <span class="badge badge-success" style="margin-right: 0.5rem;">USER STORY</span>
                                                        {{.Title}}
                                                    </div>
                                                    <div style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;">
                                                        <span>ID: {{.RequirementKey}}</span>
                                                        <span style="margin-left: 1rem;">Status: {{.Status}}</span>
                                                    </div>
                                                    <div class="description-view" onclick="event.stopPropagation(); editDescription('{{.ID}}', this)">
                                                        {{if .Description}}{{.Description}}{{else}}<em style="color: #9ca3af;">Click to add description</em>{{end}}
                                                    </div>
                                                    <div class="description-edit" data-req-id="{{.ID}}">
                                                        <textarea class="form-control" style="margin-top: 0.5rem;">{{.Description}}</textarea>
                                                        <div style="margin-top: 0.5rem;">
                                                            <button class="btn btn-sm btn-primary" onclick="saveDescription('{{.ID}}')">Save</button>
                                                            <button class="btn btn-sm" onclick="cancelEdit('{{.ID}}')">Cancel</button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="req-actions">
                                                    <button onclick="event.stopPropagation(); generateCodePrompt('story', '{{.ID}}')" class="btn btn-sm" style="background-color: #8b5cf6; color: white;" title="Generate Code Prompt for Story">ü§ñ Code Gen Prompt</button>
                                                    <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); showAddTechSpecModal('{{.ID}}', '{{.RequirementKey}}')">+ Tech Spec</button>
                                                    <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteRequirement('{{.ID}}', 'user story')">Delete</button>
                                                </div>
                                            </div>
                                            <div class="accordion-toggle">+</div>
                                        </div>
                                        <div class="accordion-content">
                                            {{if .Children}}
                                            <div style="padding: 0.75rem;">
                                                {{range .Children}}
                                                {{if or (eq .RequirementType "TECH_SPEC") (eq .RequirementType "tech_spec")}}
                                                <div style="background: #fffbeb; border: 1px solid #fde68a; border-radius: 4px; padding: 0.75rem; margin-bottom: 0.5rem;" data-requirement-id="{{.ID}}">
                                                    <div class="req-header">
                                                        <div class="req-info">
                                                            <div style="font-weight: 500; font-size: 0.9rem;">
                                                                <span class="badge badge-warning" style="margin-right: 0.5rem;">TECH SPEC</span>
                                                                {{.Title}}
                                                            </div>
                                                            <div style="font-size: 0.8rem; color: #6b7280;">
                                                                <span>ID: {{.RequirementKey}}</span>
                                                                <span style="margin-left: 0.5rem;">Status: {{.Status}}</span>
                                                            </div>
                                                            <div class="description-view" onclick="editDescription('{{.ID}}', this)">
                                                                {{if .Description}}{{.Description}}{{else}}<em style="color: #9ca3af;">Click to add description</em>{{end}}
                                                            </div>
                                                            <div class="description-edit" data-req-id="{{.ID}}">
                                                                <textarea class="form-control" style="margin-top: 0.5rem;">{{.Description}}</textarea>
                                                                <div style="margin-top: 0.5rem;">
                                                                    <button class="btn btn-sm btn-primary" onclick="saveDescription('{{.ID}}')">Save</button>
                                                                    <button class="btn btn-sm" onclick="cancelEdit('{{.ID}}')">Cancel</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="req-actions">
                                                            <button onclick="event.stopPropagation(); generateCodePrompt('techspec', '{{.ID}}')" class="btn btn-sm" style="background-color: #8b5cf6; color: white;" title="Generate Code Prompt for Tech Spec">ü§ñ Code Gen Prompt</button>
                                                            <button class="btn btn-sm btn-danger" onclick="deleteRequirement('{{.ID}}', 'tech spec')">Delete</button>
                                                        </div>
                                                    </div>
                                                </div>
                                                {{end}}
                                                {{end}}
                                            </div>
                                            {{else}}
                                            <div style="padding: 0.75rem; color: #6b7280; font-style: italic;">No tech specs defined</div>
                                            {{end}}
                                        </div>
                                    </div>
                                    {{end}}
                                    {{end}}
                                </div>
                                {{else}}
                                <div style="padding: 1rem; color: #6b7280; font-style: italic;">No user stories defined</div>
                                {{end}}
                            </div>
                        </div>
                        {{end}}
                        {{end}}
                        {{else}}
                        <div style="color: #6b7280; text-align: center; padding: 2rem; background: #f9fafb; border-radius: 4px; border: 1px solid #e5e7eb;">
                            <p>No requirements found for this component.</p>
                            <p style="font-size: 0.875rem; margin-top: 0.5rem;">Click "Add Scope" to get started!</p>
                        </div>
                        {{end}}
                    </div>
                </div>
            </div>
        </div>
        {{end}}
        {{else}}
        <div class="card">
            <div class="card-content" style="text-align: center; padding: 3rem;">
                <h2 style="color: #6b7280; margin-bottom: 1rem;">No Components Found</h2>
                <p style="color: #9ca3af; margin-bottom: 2rem;">
                    This project doesn't have any system components yet. Create your first component to get started.
                </p>
                <button onclick="showAddComponentModal()" class="btn btn-primary" style="font-size: 1rem; padding: 0.75rem 1.5rem;">
                    üèóÔ∏è Add First Component
                </button>
            </div>
        </div>
        {{end}}
    </main>

    <!-- Add Scope Modal -->
    <div id="addScopeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Scope</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="scopeTitle" class="form-control" placeholder="Enter scope title">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="scopeDescription" class="form-control" placeholder="Enter scope description"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select id="scopeCategory" class="form-control">
                        <option value="backend_api">Backend API</option>
                        <option value="frontend_ui">Frontend UI</option>
                        <option value="database">Database</option>
                        <option value="security">Security</option>
                        <option value="infrastructure">Infrastructure</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select id="scopePriority" class="form-control">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('addScopeModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addScope()">Add Scope</button>
            </div>
        </div>
    </div>

    <!-- Add Component Modal -->
    <div id="addComponentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Component</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Component Name *</label>
                    <input type="text" id="componentName" class="form-control" placeholder="Enter component name (e.g., User Service, Frontend App)">
                </div>
                <div class="form-group">
                    <label class="form-label">Component Type *</label>
                    <select id="componentType" class="form-control">
                        <option value="">Select component type</option>
                        <option value="backend_service">Backend Service</option>
                        <option value="frontend_app">Frontend Application</option>
                        <option value="database">Database</option>
                        <option value="api_gateway">API Gateway</option>
                        <option value="message_queue">Message Queue</option>
                        <option value="cache">Cache/Redis</option>
                        <option value="load_balancer">Load Balancer</option>
                        <option value="cdn">CDN</option>
                        <option value="auth_service">Authentication Service</option>
                        <option value="monitoring">Monitoring</option>
                        <option value="logging">Logging</option>
                        <option value="storage">File Storage</option>
                        <option value="external_api">External API</option>
                        <option value="microservice">Microservice</option>
                        <option value="library">Library/Package</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Technology Stack</label>
                    <input type="text" id="componentTechnology" class="form-control" placeholder="e.g., Node.js, React, PostgreSQL, Docker">
                </div>
                <div class="form-group">
                    <label class="form-label">Tags</label>
                    <input type="text" id="componentTags" class="form-control" placeholder="Enter tags separated by commas (e.g., data-ingestion, exchange, go)">
                    <small style="color: #6b7280; font-size: 0.75rem;">Suggested: data-ingestion, processing, storage, api-layer, frontend, infrastructure</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="componentDescription" class="form-control" placeholder="Describe the component's purpose and responsibilities"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('addComponentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addComponent()">Add Component</button>
            </div>
        </div>
    </div>

    <!-- Edit Component Modal -->
    <div id="editComponentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Component</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Component Name *</label>
                    <input type="text" id="editComponentName" class="form-control" placeholder="Enter component name">
                </div>
                <div class="form-group">
                    <label class="form-label">Component Type *</label>
                    <select id="editComponentType" class="form-control">
                        <option value="">Select component type</option>
                        <option value="backend_service">Backend Service</option>
                        <option value="frontend_app">Frontend Application</option>
                        <option value="database">Database</option>
                        <option value="api_gateway">API Gateway</option>
                        <option value="message_queue">Message Queue</option>
                        <option value="cache">Cache/Redis</option>
                        <option value="load_balancer">Load Balancer</option>
                        <option value="cdn">CDN</option>
                        <option value="auth_service">Authentication Service</option>
                        <option value="monitoring">Monitoring</option>
                        <option value="logging">Logging</option>
                        <option value="storage">File Storage</option>
                        <option value="external_api">External API</option>
                        <option value="microservice">Microservice</option>
                        <option value="library">Library/Package</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Technology Stack</label>
                    <input type="text" id="editComponentTechnology" class="form-control" placeholder="e.g., Node.js, React, PostgreSQL, Docker">
                </div>
                <div class="form-group">
                    <label class="form-label">Tags</label>
                    <input type="text" id="editComponentTags" class="form-control" placeholder="Enter tags separated by commas (e.g., data-ingestion, exchange, go)">
                    <small style="color: #6b7280; font-size: 0.75rem;">Suggested: data-ingestion, processing, storage, api-layer, frontend, infrastructure</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="editComponentDescription" class="form-control" placeholder="Describe the component's purpose and responsibilities"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('editComponentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="updateComponent()">Update Component</button>
            </div>
        </div>
    </div>

    <!-- Add User Story Modal -->
    <div id="addUserStoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New User Story</h2>
                <p style="color: #6b7280; margin-top: 0.5rem;">Parent Scope: <span id="parentScopeKey"></span></p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="storyTitle" class="form-control" placeholder="As a user, I want to...">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="storyDescription" class="form-control" placeholder="Enter user story description"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select id="storyPriority" class="form-control">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('addUserStoryModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addUserStory()">Add User Story</button>
            </div>
        </div>
    </div>

    <!-- Add Tech Spec Modal -->
    <div id="addTechSpecModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Tech Spec</h2>
                <p style="color: #6b7280; margin-top: 0.5rem;">Parent User Story: <span id="parentStoryKey"></span></p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="specTitle" class="form-control" placeholder="Enter technical specification">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="specDescription" class="form-control" placeholder="Enter technical details"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select id="specPriority" class="form-control">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('addTechSpecModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addTechSpec()">Add Tech Spec</button>
            </div>
        </div>
    </div>

    <!-- LLM Prompt Modal -->
    <div id="llmPromptModal" class="modal">
        <div class="modal-content" style="max-width: 800px; width: 95%;">
            <div class="modal-header">
                <h2 style="color: #8b5cf6;">ü§ñ LLM Implementation Prompt</h2>
                <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem;">Ready to copy and paste into Claude Code or any LLM</p>
            </div>
            <div class="modal-body">
                <div style="position: relative;">
                    <textarea id="llmPromptText" readonly style="width: 100%; min-height: 400px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 0.875rem; line-height: 1.5; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 6px; resize: vertical; background: #f9fafb;"></textarea>
                    <button onclick="copyPromptToClipboard()" style="position: absolute; top: 10px; right: 10px; background: #8b5cf6; color: white; border: none; padding: 0.5rem; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem;" title="Copy to clipboard">
                        <span id="copyIcon">üìã</span>
                        <span id="copyText">Copy</span>
                    </button>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: #eff6ff; border-radius: 6px; border-left: 4px solid #3b82f6;">
                    <p style="margin: 0; font-size: 0.875rem; color: #1e40af;">
                        <strong>üí° Tip:</strong> This prompt includes context about the project, component, and related requirements to help the LLM provide better implementation suggestions.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('llmPromptModal')">Close</button>
                <button class="btn btn-primary" onclick="copyPromptToClipboard()" style="background: #8b5cf6;">üìã Copy Prompt</button>
            </div>
        </div>
    </div>

    <!-- Project Context Modal -->
    <div id="projectContextModal" class="modal">
        <div class="modal-content" style="max-width: 700px; width: 95%;">
            <div class="modal-header">
                <h2 style="color: #8b5cf6;">üìù Project Context for Code Gen Prompts</h2>
                <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem;">This context will be included in all Code Gen prompts</p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Project Context</label>
                    <textarea id="projectContextText" class="form-control" style="min-height: 300px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 0.875rem; line-height: 1.5;" placeholder="Enter project-specific context, coding standards, architecture guidelines...

Example:
ARCHITECTURE: Component-based monorepo
CODING STANDARDS:
- Use descriptive variable names
- Include error handling and logging
- Add RTM reference comments /* RTM: [SPEC_ID] */
- Write tests for all functions
- Follow language-specific conventions

TECHNOLOGY STACK:
- Backend: Go 1.24+
- Frontend: HTML/CSS/JavaScript
- Database: SQLite
- Testing: Go standard testing"></textarea>
                </div>
                <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
                    <p style="margin: 0; font-size: 0.875rem; color: #92400e;">
                        <strong>üí° Note:</strong> This context will be automatically included in all Code Gen prompts. Keep it focused on architectural decisions, coding standards, and project-specific guidelines.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('projectContextModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveProjectContext()" style="background: #8b5cf6;">üíæ Save Context</button>
            </div>
        </div>
    </div>

    <script>
        // Project data from server - need to get the actual component ID
        const projectData = {
            projectId: '{{.Project.ID}}',
            projectKey: '{{.Project.ProjectKey}}',
            componentId: '{{if .Components}}{{(index .Components 0).ID}}{{else}}{{.Project.ID}}{{end}}' // Use first component or project ID as fallback
        };

        console.log('Project Data:', projectData); // Debug logging

        // Modal functions
        function showAddScopeModal(componentId) {
            console.log('Opening scope modal for component:', componentId);
            document.getElementById('addScopeModal').classList.add('active');
            // Store the component ID for use when creating the scope
            document.getElementById('addScopeModal').dataset.componentId = componentId || projectData.componentId;
        }

        function showAddComponentModal() {
            console.log('Opening add component modal');
            document.getElementById('addComponentModal').classList.add('active');
            // Clear form fields
            document.getElementById('componentName').value = '';
            document.getElementById('componentType').value = '';
            document.getElementById('componentTechnology').value = '';
            document.getElementById('componentTags').value = '';
            document.getElementById('componentDescription').value = '';
        }

        function addComponent() {
            const name = document.getElementById('componentName').value.trim();
            const type = document.getElementById('componentType').value;
            const technology = document.getElementById('componentTechnology').value.trim();
            const description = document.getElementById('componentDescription').value.trim();
            const tagsInput = document.getElementById('componentTags').value.trim();

            if (!name) {
                alert('Please enter a component name');
                return;
            }
            if (!type) {
                alert('Please select a component type');
                return;
            }

            // Parse tags from comma-separated string
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0) : [];

            const data = {
                project_id: projectData.projectId,
                component_key: name.toLowerCase().replace(/[^a-z0-9]/g, '_'),
                name: name,
                component_type: type,
                technology: technology || null,
                description: description || null,
                tags: tags
            };

            console.log('Creating component:', data);

            fetch('/api/components', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    console.log('Component created successfully:', result);
                    closeModal('addComponentModal');
                    // Reload the page to show the new component
                    window.location.reload();
                } else {
                    alert('Error creating component: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error creating component:', error);
                alert('Error creating component. Please try again.');
            });
        }

        function showAddUserStoryModal(parentId, parentKey) {
            console.log('Opening user story modal for parent:', parentId, parentKey);
            document.getElementById('addUserStoryModal').classList.add('active');
            document.getElementById('parentScopeKey').textContent = parentKey;
            document.getElementById('addUserStoryModal').dataset.parentId = parentId;
        }

        function showAddTechSpecModal(parentId, parentKey) {
            console.log('Opening tech spec modal for parent:', parentId, parentKey);
            document.getElementById('addTechSpecModal').classList.add('active');
            document.getElementById('parentStoryKey').textContent = parentKey;
            document.getElementById('addTechSpecModal').dataset.parentId = parentId;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Clear form fields
            const modal = document.getElementById(modalId);
            modal.querySelectorAll('input, textarea, select').forEach(input => {
                if (input.tagName.toLowerCase() === 'select') {
                    input.selectedIndex = input.options[0].hasAttribute('selected') ? input.selectedIndex : 0;
                } else {
                    input.value = '';
                }
            });
        }

        // Toggle component accordion
        function toggleComponentAccordion(header) {
            console.log('Toggling component accordion');
            const content = header.nextElementSibling;
            const toggle = header.querySelector('.component-toggle');
            const isActive = content.classList.contains('active');

            if (isActive) {
                content.classList.remove('active');
                header.classList.remove('active');
                toggle.classList.remove('active');
                toggle.textContent = '+';
            } else {
                content.classList.add('active');
                header.classList.add('active');
                toggle.classList.add('active');
                toggle.textContent = '‚àí';
            }
        }

        // Toggle accordion
        function toggleAccordion(header) {
            console.log('Toggling accordion');
            const content = header.nextElementSibling;
            const toggle = header.querySelector('.accordion-toggle');
            const isActive = content.classList.contains('active');

            if (isActive) {
                content.classList.remove('active');
                header.classList.remove('active');
                toggle.classList.remove('active');
                toggle.textContent = '+';
            } else {
                content.classList.add('active');
                header.classList.add('active');
                toggle.classList.add('active');
                toggle.textContent = '‚àí';
            }
        }

        // Edit description inline
        function editDescription(reqId, viewElement) {
            console.log('Editing description for:', reqId);
            viewElement.classList.add('editing');
            const editDiv = viewElement.nextElementSibling;
            editDiv.classList.add('active');
            editDiv.querySelector('textarea').focus();
        }

        function cancelEdit(reqId) {
            console.log('Canceling edit for:', reqId);
            const editDiv = document.querySelector(`.description-edit[data-req-id="${reqId}"]`);
            const viewDiv = editDiv.previousElementSibling;
            editDiv.classList.remove('active');
            viewDiv.classList.remove('editing');
        }

        async function saveDescription(reqId) {
            console.log('Saving description for:', reqId);
            const editDiv = document.querySelector(`.description-edit[data-req-id="${reqId}"]`);
            const viewDiv = editDiv.previousElementSibling;
            const description = editDiv.querySelector('textarea').value;

            try {
                const response = await fetch(`/api/requirements/${reqId}/description`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description })
                });

                if (response.ok) {
                    viewDiv.innerHTML = description || '<em style="color: #9ca3af;">Click to add description</em>';
                    editDiv.classList.remove('active');
                    viewDiv.classList.remove('editing');
                } else {
                    const error = await response.text();
                    alert('Failed to update description: ' + error);
                }
            } catch (error) {
                console.error('Error updating description:', error);
                alert('Error updating description: ' + error.message);
            }
        }

        // Add new scope
        async function addScope() {
            const title = document.getElementById('scopeTitle').value;
            const description = document.getElementById('scopeDescription').value;
            const category = document.getElementById('scopeCategory').value;
            const priority = document.getElementById('scopePriority').value;

            if (!title) {
                alert('Please enter a title');
                return;
            }

            // Get the component ID from the modal's dataset
            const modal = document.getElementById('addScopeModal');
            const componentId = modal.dataset.componentId;

            console.log('Creating scope:', { title, description, category, priority, componentId });

            try {
                const response = await fetch('/api/requirements/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: projectData.projectId,
                        component_id: componentId,
                        requirement_type: 'scope',
                        title,
                        description: description || null,
                        category,
                        priority,
                        status: 'not_started'
                    })
                });

                if (response.ok) {
                    closeModal('addScopeModal');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Failed to create scope: ' + error);
                }
            } catch (error) {
                console.error('Error creating scope:', error);
                alert('Error creating scope: ' + error.message);
            }
        }

        // Add new user story
        async function addUserStory() {
            const modal = document.getElementById('addUserStoryModal');
            const parentId = modal.dataset.parentId;
            const title = document.getElementById('storyTitle').value;
            const description = document.getElementById('storyDescription').value;
            const priority = document.getElementById('storyPriority').value;

            if (!title) {
                alert('Please enter a title');
                return;
            }

            console.log('Creating user story:', { title, description, priority, parentId });

            try {
                const response = await fetch('/api/requirements/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: projectData.projectId,
                        component_id: projectData.componentId,
                        parent_requirement_id: parentId,
                        requirement_type: 'user_story',
                        title,
                        description: description || null,
                        category: 'feature',
                        priority,
                        status: 'not_started'
                    })
                });

                if (response.ok) {
                    closeModal('addUserStoryModal');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Failed to create user story: ' + error);
                }
            } catch (error) {
                console.error('Error creating user story:', error);
                alert('Error creating user story: ' + error.message);
            }
        }

        // Add new tech spec
        async function addTechSpec() {
            const modal = document.getElementById('addTechSpecModal');
            const parentId = modal.dataset.parentId;
            const title = document.getElementById('specTitle').value;
            const description = document.getElementById('specDescription').value;
            const priority = document.getElementById('specPriority').value;

            if (!title) {
                alert('Please enter a title');
                return;
            }

            console.log('Creating tech spec:', { title, description, priority, parentId });

            try {
                const response = await fetch('/api/requirements/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: projectData.projectId,
                        component_id: projectData.componentId,
                        parent_requirement_id: parentId,
                        requirement_type: 'tech_spec',
                        title,
                        description: description || null,
                        category: 'technical',
                        priority,
                        status: 'not_started'
                    })
                });

                if (response.ok) {
                    closeModal('addTechSpecModal');
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Failed to create tech spec: ' + error);
                }
            } catch (error) {
                console.error('Error creating tech spec:', error);
                alert('Error creating tech spec: ' + error.message);
            }
        }

        // Delete requirement
        async function deleteRequirement(reqId, reqType) {
            if (!confirm(`Are you sure you want to delete this ${reqType}? This will also delete all child requirements.`)) {
                return;
            }

            console.log('Deleting requirement:', reqId, reqType);

            try {
                const response = await fetch(`/api/requirements/${reqId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    const error = await response.text();
                    alert('Failed to delete requirement: ' + error);
                }
            } catch (error) {
                console.error('Error deleting requirement:', error);
                alert('Error deleting requirement: ' + error.message);
            }
        }

        // Export dropdown functionality
        function toggleExportDropdown() {
            console.log('Toggling export dropdown');
            const dropdown = document.getElementById('exportDropdown');
            const isVisible = dropdown.style.display !== 'none';

            if (isVisible) {
                dropdown.style.display = 'none';
            } else {
                dropdown.style.display = 'block';
            }
        }

        // Close modals and dropdowns when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }

            // Close export dropdown if clicking outside
            const dropdown = document.getElementById('exportDropdown');
            const exportButton = event.target.closest('button');
            if (dropdown && !exportButton && dropdown.style.display === 'block') {
                dropdown.style.display = 'none';
            }
        }

        // Generate LLM Prompt functionality
        function generateLLMPrompt(reqId, title, description, reqKey, status, priority) {
            console.log('Generating LLM prompt for:', reqId, title);

            // Get project and component context
            const projectName = '{{.Project.Name}}';
            const projectKey = '{{.Project.ProjectKey}}';
            const projectDescription = '{{if .Project.Description}}{{.Project.Description}}{{else}}No description available{{end}}';

            // Find the parent scope and related tech specs
            let parentScope = '';
            let relatedTechSpecs = [];
            let componentName = '';

            // Try to find context from the DOM
            const userStoryElement = document.querySelector(`[data-requirement-id="${reqId}"]`);
            if (userStoryElement) {
                // Find parent scope
                const parentAccordion = userStoryElement.closest('.accordion-content')?.previousElementSibling?.querySelector('.req-info .badge-info')?.parentElement?.textContent?.replace('SCOPE', '').trim();
                if (parentAccordion) {
                    parentScope = parentAccordion;
                }

                // Find component name
                const componentAccordion = userStoryElement.closest('.component-content')?.previousElementSibling?.querySelector('h2')?.textContent;
                if (componentAccordion) {
                    componentName = componentAccordion;
                }

                // Find tech specs under this user story
                const techSpecElements = userStoryElement.querySelectorAll('.badge-warning');
                techSpecElements.forEach(badge => {
                    const techSpecText = badge.parentElement.textContent.replace('TECH SPEC', '').trim();
                    if (techSpecText) {
                        relatedTechSpecs.push(techSpecText);
                    }
                });
            }

            // Clean up description (remove template artifacts)
            let cleanDescription = description || 'No description provided';
            cleanDescription = cleanDescription.replace(/\{\{.*?\}\}/g, '').trim();
            if (cleanDescription === '' || cleanDescription === 'undefined') {
                cleanDescription = 'No description provided';
            }

            // Generate the comprehensive prompt
            let prompt = '# User Story Implementation Request\n\n';
            prompt += '## Project Context\n';
            prompt += '**Project:** ' + projectName + ' (' + projectKey + ')\n';
            prompt += '**Project Description:** ' + projectDescription + '\n';
            if (componentName) {
                prompt += '**Component:** ' + componentName + '\n';
            }
            if (parentScope) {
                prompt += '**Parent Scope:** ' + parentScope + '\n';
            }
            prompt += '\n## User Story Details\n';
            prompt += '**ID:** ' + reqKey + '\n';
            prompt += '**Title:** ' + title + '\n';
            prompt += '**Description:** ' + cleanDescription + '\n';
            prompt += '**Status:** ' + status + '\n';
            prompt += '**Priority:** ' + priority + '\n\n';

            if (relatedTechSpecs.length > 0) {
                prompt += '## Related Technical Specifications\n';
                relatedTechSpecs.forEach(spec => {
                    prompt += '- ' + spec + '\n';
                });
                prompt += '\n';
            }

            prompt += '## Implementation Request\n\n';
            prompt += 'Please help me implement this user story. I need:\n\n';
            prompt += '1. **Code Implementation**: Provide the necessary code changes, new functions, or components needed\n';
            prompt += '2. **Technical Approach**: Explain the implementation strategy and any architectural considerations\n';
            prompt += '3. **Dependencies**: Identify any libraries, frameworks, or external dependencies required\n';
            prompt += '4. **Testing Strategy**: Suggest how to test this implementation (unit tests, integration tests)\n';
            prompt += '5. **Documentation**: Include any necessary code comments or documentation updates\n\n';
            prompt += '## Additional Context\n\n';
            prompt += '- This is part of a Requirements Traceability Matrix (RTM) system\n';
            prompt += '- Please consider best practices for the technology stack being used\n';
            prompt += '- If you need more information about the project structure or existing codebase, please ask\n';
            prompt += '- Consider security, performance, and maintainability in your implementation\n\n';
            prompt += '## Expected Deliverables\n\n';
            prompt += 'Please provide:\n';
            prompt += '- [ ] Implementation code with proper error handling\n';
            prompt += '- [ ] Test cases or testing instructions\n';
            prompt += '- [ ] Brief explanation of the approach taken\n';
            prompt += '- [ ] Any assumptions made during implementation\n\n';
            prompt += '---\n';
            prompt += '*Generated from TraceVibe RTM - User Story: ' + reqKey + '*';

            // Set the prompt in the modal and show it
            document.getElementById('llmPromptText').value = prompt;
            document.getElementById('llmPromptModal').classList.add('active');
        }

        // Generate Code Prompt functionality (new unified function)
        function generateCodePrompt(level, itemId) {
            console.log('Generating Code Prompt for:', level, itemId);

            const projectName = '{{.Project.Name}}';
            const projectKey = '{{.Project.ProjectKey}}';
            const projectDescription = '{{if .Project.Description}}{{.Project.Description}}{{else}}No description available{{end}}';

            // Get saved project context
            const savedProjectContext = localStorage.getItem('projectContext_' + projectKey) || '';

            let prompt = '';

            // Build prompt based on level
            if (level === 'component') {
                prompt = buildComponentPrompt(itemId, projectName, projectKey, projectDescription, savedProjectContext);
            } else if (level === 'scope') {
                prompt = buildScopePrompt(itemId, projectName, projectKey, projectDescription, savedProjectContext);
            } else if (level === 'story') {
                prompt = buildStoryPrompt(itemId, projectName, projectKey, projectDescription, savedProjectContext);
            } else if (level === 'techspec') {
                prompt = buildTechSpecPrompt(itemId, projectName, projectKey, projectDescription, savedProjectContext);
            }

            // Show prompt in modal
            document.getElementById('llmPromptText').value = prompt;
            document.getElementById('llmPromptModal').classList.add('active');
        }

        function buildComponentPrompt(componentId, projectName, projectKey, projectDescription, projectContext) {
            let prompt = '# Component Implementation Request\n\n';

            if (projectContext) {
                prompt += '## Project Context\n' + projectContext + '\n\n';
            }

            prompt += '## Project Information\n';
            prompt += '**Project:** ' + projectName + ' (' + projectKey + ')\n';
            prompt += '**Project Description:** ' + projectDescription + '\n\n';

            // Find the component accordion
            const componentAccordion = document.querySelector(`[data-component-id="${componentId}"]`);
            if (componentAccordion) {
                // Extract component details
                const componentHeader = componentAccordion.querySelector('.component-header');
                const componentName = componentHeader.querySelector('h3').textContent;
                const componentDetails = componentHeader.querySelector('.component-details');

                let componentInfo = '';
                if (componentDetails) {
                    const typeSpan = componentDetails.querySelector('span');
                    if (typeSpan) componentInfo = typeSpan.textContent;
                }

                const tagsAttr = componentAccordion.getAttribute('data-component-tags');
                const tags = tagsAttr ? tagsAttr.split(',').map(t => t.trim()).filter(t => t) : [];

                prompt += '## Component Details\n';
                prompt += `**Component Name:** ${componentName}\n`;
                if (componentInfo) prompt += `**Component Info:** ${componentInfo}\n`;
                if (tags.length > 0) prompt += `**Tags:** ${tags.join(', ')}\n`;

                // Extract description if available
                const descDiv = componentHeader.querySelector('.description-view, .description-full');
                if (descDiv && descDiv.textContent.trim() && !descDiv.textContent.includes('Click to add')) {
                    prompt += `**Description:** ${descDiv.textContent.trim()}\n`;
                }
                prompt += '\n';

                // Extract all requirements (scopes, stories, tech specs)
                const requirementsTree = componentAccordion.querySelector('.requirements-tree');
                if (requirementsTree) {
                    const scopes = requirementsTree.querySelectorAll('[data-requirement-id]');
                    let scopeCount = 0;
                    let storyCount = 0;
                    let techSpecCount = 0;

                    prompt += '## Requirements Hierarchy\n\n';

                    scopes.forEach(scopeEl => {
                        const scopeBadge = scopeEl.querySelector('.badge-info');
                        if (scopeBadge && scopeBadge.textContent.includes('SCOPE')) {
                            scopeCount++;
                            const scopeTitle = scopeEl.querySelector('.req-info > div').textContent.replace(/^SCOPE\s*/, '');
                            const scopeId = scopeEl.querySelector('.req-info > div:nth-child(2)').textContent.match(/ID: ([^\s]+)/)?.[1] || '';
                            const scopeDesc = scopeEl.querySelector('.description-view');
                            const scopeDescText = scopeDesc && !scopeDesc.textContent.includes('Click to add') ? scopeDesc.textContent.trim() : '';

                            prompt += `### üìÅ Scope ${scopeCount}: ${scopeTitle}\n`;
                            prompt += `**ID:** ${scopeId}\n`;
                            if (scopeDescText) prompt += `**Description:** ${scopeDescText}\n`;

                            // Find user stories within this scope
                            const stories = scopeEl.querySelectorAll('[data-requirement-id]');
                            let scopeStoryCount = 0;

                            stories.forEach(storyEl => {
                                const storyBadge = storyEl.querySelector('.badge-success');
                                if (storyBadge && storyBadge.textContent.includes('USER STORY')) {
                                    scopeStoryCount++;
                                    storyCount++;
                                    const storyTitle = storyEl.querySelector('.req-info > div').textContent.replace(/^USER STORY\s*/, '');
                                    const storyId = storyEl.querySelector('.req-info > div:nth-child(2)').textContent.match(/ID: ([^\s]+)/)?.[1] || '';
                                    const storyDesc = storyEl.querySelector('.description-view');
                                    const storyDescText = storyDesc && !storyDesc.textContent.includes('Click to add') ? storyDesc.textContent.trim() : '';

                                    prompt += `\n#### üìã Story ${scopeCount}.${scopeStoryCount}: ${storyTitle}\n`;
                                    prompt += `**ID:** ${storyId}\n`;
                                    if (storyDescText) prompt += `**Description:** ${storyDescText}\n`;

                                    // Find tech specs within this story
                                    const techSpecs = storyEl.querySelectorAll('[data-requirement-id]');
                                    let storySpecCount = 0;

                                    techSpecs.forEach(specEl => {
                                        const specBadge = specEl.querySelector('.badge-warning');
                                        if (specBadge && specBadge.textContent.includes('TECH SPEC')) {
                                            storySpecCount++;
                                            techSpecCount++;
                                            const specTitle = specEl.querySelector('.req-info > div').textContent.replace(/^TECH SPEC\s*/, '');
                                            const specId = specEl.querySelector('.req-info > div:nth-child(2)').textContent.match(/ID: ([^\s]+)/)?.[1] || '';
                                            const specDesc = specEl.querySelector('.description-view');
                                            const specDescText = specDesc && !specDesc.textContent.includes('Click to add') ? specDesc.textContent.trim() : '';

                                            prompt += `\n##### ‚öôÔ∏è Tech Spec ${scopeCount}.${scopeStoryCount}.${storySpecCount}: ${specTitle}\n`;
                                            prompt += `**ID:** ${specId}\n`;
                                            if (specDescText) prompt += `**Requirements:** ${specDescText}\n`;
                                        }
                                    });
                                }
                            });
                            prompt += '\n';
                        }
                    });

                    prompt += `## Requirements Summary\n`;
                    prompt += `- **Scopes:** ${scopeCount}\n`;
                    prompt += `- **User Stories:** ${storyCount}\n`;
                    prompt += `- **Tech Specs:** ${techSpecCount}\n\n`;
                }
            }

            prompt += '## Implementation Request\n';
            prompt += 'Please help me implement this entire component with all its requirements listed above.\n\n';

            prompt += '## Expected Deliverables\n';
            prompt += '- Complete component implementation covering all scopes and user stories\n';
            prompt += '- Implementation for all technical specifications\n';
            prompt += '- Comprehensive test suite\n';
            prompt += '- Documentation and code comments\n';
            prompt += '- Error handling and edge cases\n\n';

            prompt += '---\n*Generated from TraceVibe RTM - Component Level*';
            return prompt;
        }

        function buildScopePrompt(scopeId, projectName, projectKey, projectDescription, projectContext) {
            let prompt = '# Scope Implementation Request\n\n';

            if (projectContext) {
                prompt += '## Project Context\n' + projectContext + '\n\n';
            }

            prompt += '## Project Information\n';
            prompt += '**Project:** ' + projectName + ' (' + projectKey + ')\n';
            prompt += '**Project Description:** ' + projectDescription + '\n\n';

            // Find the specific scope element
            const scopeElement = document.querySelector(`[data-requirement-id="${scopeId}"]`);
            if (scopeElement) {
                // Extract scope details
                const scopeTitle = scopeElement.querySelector('.req-info > div').textContent.replace(/^SCOPE\s*/, '');
                const scopeDetails = scopeElement.querySelector('.req-info > div:nth-child(2)').textContent;
                const scopeDesc = scopeElement.querySelector('.description-view');
                const scopeDescText = scopeDesc && !scopeDesc.textContent.includes('Click to add') ? scopeDesc.textContent.trim() : '';

                // Extract component context
                const componentAccordion = scopeElement.closest('[data-component-id]');
                let componentName = '';
                let componentInfo = '';
                if (componentAccordion) {
                    const componentHeader = componentAccordion.querySelector('.component-header h3');
                    if (componentHeader) componentName = componentHeader.textContent;
                    const componentDetails = componentAccordion.querySelector('.component-details span');
                    if (componentDetails) componentInfo = componentDetails.textContent;
                }

                prompt += '## Parent Component\n';
                if (componentName) prompt += `**Component:** ${componentName}\n`;
                if (componentInfo) prompt += `**Component Type:** ${componentInfo}\n`;
                prompt += '\n';

                prompt += '## Scope Details\n';
                prompt += `**Scope Name:** ${scopeTitle}\n`;
                const scopeIdMatch = scopeDetails.match(/ID: ([^\s]+)/);
                const scopeStatusMatch = scopeDetails.match(/Status: ([^\s]+)/);
                const scopePriorityMatch = scopeDetails.match(/Priority: ([^\s]+)/);
                if (scopeIdMatch) prompt += `**ID:** ${scopeIdMatch[1]}\n`;
                if (scopeStatusMatch) prompt += `**Status:** ${scopeStatusMatch[1]}\n`;
                if (scopePriorityMatch) prompt += `**Priority:** ${scopePriorityMatch[1]}\n`;
                if (scopeDescText) prompt += `**Description:** ${scopeDescText}\n`;
                prompt += '\n';

                // Extract all user stories within this scope
                const stories = scopeElement.querySelectorAll('[data-requirement-id]');
                let storyCount = 0;
                let techSpecCount = 0;

                prompt += '## User Stories in this Scope\n\n';

                stories.forEach(storyEl => {
                    const storyBadge = storyEl.querySelector('.badge-success');
                    if (storyBadge && storyBadge.textContent.includes('USER STORY')) {
                        storyCount++;
                        const storyTitle = storyEl.querySelector('.req-info > div').textContent.replace(/^USER STORY\s*/, '');
                        const storyDetails = storyEl.querySelector('.req-info > div:nth-child(2)').textContent;
                        const storyDesc = storyEl.querySelector('.description-view');
                        const storyDescText = storyDesc && !storyDesc.textContent.includes('Click to add') ? storyDesc.textContent.trim() : '';

                        prompt += `### üìã Story ${storyCount}: ${storyTitle}\n`;
                        const storyIdMatch = storyDetails.match(/ID: ([^\s]+)/);
                        const storyStatusMatch = storyDetails.match(/Status: ([^\s]+)/);
                        if (storyIdMatch) prompt += `**ID:** ${storyIdMatch[1]}\n`;
                        if (storyStatusMatch) prompt += `**Status:** ${storyStatusMatch[1]}\n`;
                        if (storyDescText) prompt += `**Description:** ${storyDescText}\n`;

                        // Find tech specs within this story
                        const techSpecs = storyEl.querySelectorAll('[data-requirement-id]');
                        let storySpecCount = 0;

                        techSpecs.forEach(specEl => {
                            const specBadge = specEl.querySelector('.badge-warning');
                            if (specBadge && specBadge.textContent.includes('TECH SPEC')) {
                                storySpecCount++;
                                techSpecCount++;
                                const specTitle = specEl.querySelector('.req-info > div').textContent.replace(/^TECH SPEC\s*/, '');
                                const specDetails = specEl.querySelector('.req-info > div:nth-child(2)').textContent;
                                const specDesc = specEl.querySelector('.description-view');
                                const specDescText = specDesc && !specDesc.textContent.includes('Click to add') ? specDesc.textContent.trim() : '';

                                prompt += `\n#### ‚öôÔ∏è Tech Spec ${storyCount}.${storySpecCount}: ${specTitle}\n`;
                                const specIdMatch = specDetails.match(/ID: ([^\s]+)/);
                                if (specIdMatch) prompt += `**ID:** ${specIdMatch[1]}\n`;
                                if (specDescText) prompt += `**Requirements:** ${specDescText}\n`;
                            }
                        });
                        prompt += '\n';
                    }
                });

                prompt += `## Requirements Summary\n`;
                prompt += `- **User Stories:** ${storyCount}\n`;
                prompt += `- **Tech Specs:** ${techSpecCount}\n\n`;
            }

            prompt += '## Implementation Request\n';
            prompt += 'Please help me implement this functional scope with all its user stories and technical specifications listed above.\n\n';

            prompt += '## Expected Deliverables\n';
            prompt += '- Scope architecture design\n';
            prompt += '- Implementation for all user stories\n';
            prompt += '- Implementation for all technical specifications\n';
            prompt += '- Testing strategy and test cases\n';
            prompt += '- Error handling and validation\n\n';

            prompt += '---\n*Generated from TraceVibe RTM - Scope Level*';
            return prompt;
        }

        function buildStoryPrompt(storyId, projectName, projectKey, projectDescription, projectContext) {
            let prompt = '# User Story Implementation Request\n\n';

            if (projectContext) {
                prompt += '## Project Context\n' + projectContext + '\n\n';
            }

            prompt += '## Project Information\n';
            prompt += '**Project:** ' + projectName + ' (' + projectKey + ')\n';
            prompt += '**Project Description:** ' + projectDescription + '\n\n';

            // Find the specific story element
            const storyElement = document.querySelector(`[data-requirement-id="${storyId}"]`);
            if (storyElement) {
                // Extract component context
                const componentAccordion = storyElement.closest('[data-component-id]');
                let componentName = '';
                let componentInfo = '';
                if (componentAccordion) {
                    const componentHeader = componentAccordion.querySelector('.component-header h3');
                    if (componentHeader) componentName = componentHeader.textContent;
                    const componentDetails = componentAccordion.querySelector('.component-details span');
                    if (componentDetails) componentInfo = componentDetails.textContent;
                }

                // Extract scope context
                const scopeElement = storyElement.closest('[data-requirement-id]').parentElement.closest('[data-requirement-id]');
                let scopeName = '';
                let scopeId = '';
                if (scopeElement) {
                    const scopeBadge = scopeElement.querySelector('.badge-info');
                    if (scopeBadge && scopeBadge.textContent.includes('SCOPE')) {
                        scopeName = scopeElement.querySelector('.req-info > div').textContent.replace(/^SCOPE\s*/, '');
                        const scopeDetails = scopeElement.querySelector('.req-info > div:nth-child(2)').textContent;
                        const scopeIdMatch = scopeDetails.match(/ID: ([^\s]+)/);
                        if (scopeIdMatch) scopeId = scopeIdMatch[1];
                    }
                }

                // Extract story details
                const storyTitle = storyElement.querySelector('.req-info > div').textContent.replace(/^USER STORY\s*/, '');
                const storyDetails = storyElement.querySelector('.req-info > div:nth-child(2)').textContent;
                const storyDesc = storyElement.querySelector('.description-view');
                const storyDescText = storyDesc && !storyDesc.textContent.includes('Click to add') ? storyDesc.textContent.trim() : '';

                prompt += '## Context Hierarchy\n';
                if (componentName) prompt += `**Component:** ${componentName}\n`;
                if (componentInfo) prompt += `**Component Type:** ${componentInfo}\n`;
                if (scopeName) prompt += `**Parent Scope:** ${scopeName} (${scopeId})\n`;
                prompt += '\n';

                prompt += '## User Story Details\n';
                prompt += `**Story Name:** ${storyTitle}\n`;
                const storyIdMatch = storyDetails.match(/ID: ([^\s]+)/);
                const storyStatusMatch = storyDetails.match(/Status: ([^\s]+)/);
                if (storyIdMatch) prompt += `**ID:** ${storyIdMatch[1]}\n`;
                if (storyStatusMatch) prompt += `**Status:** ${storyStatusMatch[1]}\n`;
                if (storyDescText) prompt += `**Description:** ${storyDescText}\n`;
                prompt += '\n';

                // Extract all tech specs within this story
                const techSpecs = storyElement.querySelectorAll('[data-requirement-id]');
                let techSpecCount = 0;

                prompt += '## Technical Specifications\n\n';

                techSpecs.forEach(specEl => {
                    const specBadge = specEl.querySelector('.badge-warning');
                    if (specBadge && specBadge.textContent.includes('TECH SPEC')) {
                        techSpecCount++;
                        const specTitle = specEl.querySelector('.req-info > div').textContent.replace(/^TECH SPEC\s*/, '');
                        const specDetails = specEl.querySelector('.req-info > div:nth-child(2)').textContent;
                        const specDesc = specEl.querySelector('.description-view');
                        const specDescText = specDesc && !specDesc.textContent.includes('Click to add') ? specDesc.textContent.trim() : '';

                        prompt += `### ‚öôÔ∏è Tech Spec ${techSpecCount}: ${specTitle}\n`;
                        const specIdMatch = specDetails.match(/ID: ([^\s]+)/);
                        const specStatusMatch = specDetails.match(/Status: ([^\s]+)/);
                        if (specIdMatch) prompt += `**ID:** ${specIdMatch[1]}\n`;
                        if (specStatusMatch) prompt += `**Status:** ${specStatusMatch[1]}\n`;
                        if (specDescText) prompt += `**Requirements:** ${specDescText}\n`;
                        prompt += '\n';
                    }
                });

                prompt += `## Implementation Summary\n`;
                prompt += `- **Technical Specifications:** ${techSpecCount}\n\n`;
            }

            prompt += '## Implementation Request\n';
            prompt += 'Please help me implement this user story with all its technical specifications listed above.\n\n';

            prompt += '## Expected Deliverables\n';
            prompt += '- User story implementation\n';
            prompt += '- Implementation for all technical specifications\n';
            prompt += '- Unit tests for each tech spec\n';
            prompt += '- Integration tests for the complete user story\n';
            prompt += '- Error handling and validation\n';
            prompt += '- Documentation and code comments\n\n';

            prompt += '---\n*Generated from TraceVibe RTM - Story Level*';
            return prompt;
        }

        function buildTechSpecPrompt(techSpecId, projectName, projectKey, projectDescription, projectContext) {
            let prompt = '# Technical Specification Implementation\n\n';

            if (projectContext) {
                prompt += '## Project Context\n' + projectContext + '\n\n';
            }

            prompt += '## Project Information\n';
            prompt += '**Project:** ' + projectName + ' (' + projectKey + ')\n';
            prompt += '**Project Description:** ' + projectDescription + '\n\n';

            // Find the specific tech spec element
            const techSpecElement = document.querySelector(`[data-requirement-id="${techSpecId}"]`);
            if (techSpecElement) {
                // Extract component context
                const componentAccordion = techSpecElement.closest('[data-component-id]');
                let componentName = '';
                let componentInfo = '';
                if (componentAccordion) {
                    const componentHeader = componentAccordion.querySelector('.component-header h3');
                    if (componentHeader) componentName = componentHeader.textContent;
                    const componentDetails = componentAccordion.querySelector('.component-details span');
                    if (componentDetails) componentInfo = componentDetails.textContent;
                }

                // Extract scope context by traversing up the DOM
                let scopeElement = techSpecElement.parentElement;
                while (scopeElement && !scopeElement.querySelector('.badge-info')) {
                    scopeElement = scopeElement.parentElement;
                }
                let scopeName = '';
                let scopeId = '';
                if (scopeElement) {
                    const scopeBadge = scopeElement.querySelector('.badge-info');
                    if (scopeBadge && scopeBadge.textContent.includes('SCOPE')) {
                        scopeName = scopeElement.querySelector('.req-info > div').textContent.replace(/^SCOPE\s*/, '');
                        const scopeDetails = scopeElement.querySelector('.req-info > div:nth-child(2)').textContent;
                        const scopeIdMatch = scopeDetails.match(/ID: ([^\s]+)/);
                        if (scopeIdMatch) scopeId = scopeIdMatch[1];
                    }
                }

                // Extract story context by traversing up the DOM
                let storyElement = techSpecElement.parentElement;
                while (storyElement && !storyElement.querySelector('.badge-success')) {
                    storyElement = storyElement.parentElement;
                }
                let storyName = '';
                let storyId = '';
                let storyDesc = '';
                if (storyElement) {
                    const storyBadge = storyElement.querySelector('.badge-success');
                    if (storyBadge && storyBadge.textContent.includes('USER STORY')) {
                        storyName = storyElement.querySelector('.req-info > div').textContent.replace(/^USER STORY\s*/, '');
                        const storyDetails = storyElement.querySelector('.req-info > div:nth-child(2)').textContent;
                        const storyIdMatch = storyDetails.match(/ID: ([^\s]+)/);
                        if (storyIdMatch) storyId = storyIdMatch[1];
                        const storyDescEl = storyElement.querySelector('.description-view');
                        if (storyDescEl && !storyDescEl.textContent.includes('Click to add')) {
                            storyDesc = storyDescEl.textContent.trim();
                        }
                    }
                }

                // Extract tech spec details
                const specTitle = techSpecElement.querySelector('.req-info > div').textContent.replace(/^TECH SPEC\s*/, '');
                const specDetails = techSpecElement.querySelector('.req-info > div:nth-child(2)').textContent;
                const specDesc = techSpecElement.querySelector('.description-view');
                const specDescText = specDesc && !specDesc.textContent.includes('Click to add') ? specDesc.textContent.trim() : '';

                prompt += '## Context Hierarchy\n';
                if (componentName) prompt += `**Component:** ${componentName}\n`;
                if (componentInfo) prompt += `**Component Type:** ${componentInfo}\n`;
                if (scopeName) prompt += `**Parent Scope:** ${scopeName} (${scopeId})\n`;
                if (storyName) prompt += `**Parent User Story:** ${storyName} (${storyId})\n`;
                if (storyDesc) prompt += `**Story Description:** ${storyDesc}\n`;
                prompt += '\n';

                prompt += '## Technical Specification Details\n';
                prompt += `**Tech Spec Name:** ${specTitle}\n`;
                const specIdMatch = specDetails.match(/ID: ([^\s]+)/);
                const specStatusMatch = specDetails.match(/Status: ([^\s]+)/);
                if (specIdMatch) prompt += `**ID:** ${specIdMatch[1]}\n`;
                if (specStatusMatch) prompt += `**Status:** ${specStatusMatch[1]}\n`;
                if (specDescText) prompt += `**Requirements:** ${specDescText}\n`;
                prompt += '\n';

                // Show related tech specs in the same story
                if (storyElement) {
                    const allTechSpecs = storyElement.querySelectorAll('[data-requirement-id]');
                    const otherSpecs = [];

                    allTechSpecs.forEach(specEl => {
                        const specBadge = specEl.querySelector('.badge-warning');
                        if (specBadge && specBadge.textContent.includes('TECH SPEC')) {
                            const relatedSpecId = specEl.getAttribute('data-requirement-id');
                            if (relatedSpecId !== techSpecId) {
                                const relatedSpecTitle = specEl.querySelector('.req-info > div').textContent.replace(/^TECH SPEC\s*/, '');
                                const relatedSpecDetails = specEl.querySelector('.req-info > div:nth-child(2)').textContent;
                                const relatedSpecIdMatch = relatedSpecDetails.match(/ID: ([^\s]+)/);
                                otherSpecs.push(`- ${relatedSpecTitle} (${relatedSpecIdMatch ? relatedSpecIdMatch[1] : 'N/A'})`);
                            }
                        }
                    });

                    if (otherSpecs.length > 0) {
                        prompt += '## Related Tech Specs in Same Story\n';
                        prompt += otherSpecs.join('\n') + '\n\n';
                        prompt += '*Consider how this spec relates to and integrates with the above specifications.*\n\n';
                    }
                }
            }

            prompt += '## Implementation Request\n';
            prompt += 'Please help me implement this specific technical specification within the context of its parent user story and scope.\n\n';

            prompt += '## Expected Deliverables\n';
            prompt += '- Focused implementation for this specific tech spec\n';
            prompt += '- Unit tests specifically for this specification\n';
            prompt += '- Error handling and validation\n';
            prompt += '- Integration considerations with related tech specs\n';
            prompt += '- Documentation and inline comments\n\n';

            prompt += '---\n*Generated from TraceVibe RTM - Tech Spec Level*';
            return prompt;
        }

        // Project Context Management
        function showProjectContextModal() {
            const projectKey = '{{.Project.ProjectKey}}';
            const savedContext = localStorage.getItem('projectContext_' + projectKey) || '';
            document.getElementById('projectContextText').value = savedContext;
            document.getElementById('projectContextModal').classList.add('active');
        }

        function saveProjectContext() {
            const projectKey = '{{.Project.ProjectKey}}';
            const contextText = document.getElementById('projectContextText').value;
            localStorage.setItem('projectContext_' + projectKey, contextText);

            // Show success feedback
            const saveButton = document.querySelector('#projectContextModal .btn-primary');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = '‚úÖ Saved!';
            saveButton.style.backgroundColor = '#10b981';

            setTimeout(() => {
                saveButton.innerHTML = originalText;
                saveButton.style.backgroundColor = '#8b5cf6';
                closeModal('projectContextModal');
            }, 1500);
        }

        // Copy prompt to clipboard functionality
        async function copyPromptToClipboard() {
            const promptText = document.getElementById('llmPromptText').value;
            const copyIcon = document.getElementById('copyIcon');
            const copyText = document.getElementById('copyText');

            try {
                await navigator.clipboard.writeText(promptText);

                // Show success feedback
                copyIcon.textContent = '‚úÖ';
                copyText.textContent = 'Copied!';

                // Reset after 2 seconds
                setTimeout(() => {
                    copyIcon.textContent = 'üìã';
                    copyText.textContent = 'Copy';
                }, 2000);

                console.log('Prompt copied to clipboard successfully');
            } catch (err) {
                console.error('Failed to copy to clipboard:', err);

                // Fallback: select the text for manual copying
                document.getElementById('llmPromptText').select();
                document.getElementById('llmPromptText').setSelectionRange(0, 99999); // For mobile devices

                // Show fallback feedback
                copyIcon.textContent = 'üìù';
                copyText.textContent = 'Selected';

                setTimeout(() => {
                    copyIcon.textContent = 'üìã';
                    copyText.textContent = 'Copy';
                }, 2000);

                alert('Please copy the selected text manually (Ctrl+C or Cmd+C)');
            }
        }

        // Tag filtering functionality
        let selectedTags = new Set();

        function initializeTagFilters() {
            const tagSet = new Set();
            const components = document.querySelectorAll('.component-accordion');

            components.forEach(component => {
                const tagsAttr = component.getAttribute('data-component-tags');
                if (tagsAttr) {
                    const tags = tagsAttr.split(',').map(tag => tag.trim()).filter(tag => tag);
                    tags.forEach(tag => tagSet.add(tag));
                }
            });

            const tagFiltersContainer = document.getElementById('tagFilters');
            if (tagFiltersContainer && tagSet.size > 0) {
                tagFiltersContainer.innerHTML = '';
                Array.from(tagSet).sort().forEach(tag => {
                    const tagButton = document.createElement('button');
                    tagButton.className = 'tag-filter-btn';
                    tagButton.textContent = tag;
                    tagButton.onclick = () => toggleTagFilter(tag);
                    tagButton.style.cssText = `
                        padding: 0.25rem 0.75rem;
                        border: 2px solid #d1d5db;
                        background: white;
                        color: #374151;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 0.875rem;
                        font-weight: 500;
                        transition: all 0.2s;
                    `;
                    tagFiltersContainer.appendChild(tagButton);
                });
            }

            // Initialize component counter
            updateComponentCounter(components.length, components.length);
        }

        function toggleTagFilter(tag) {
            if (selectedTags.has(tag)) {
                selectedTags.delete(tag);
            } else {
                selectedTags.add(tag);
            }
            updateTagFilterButtons();
            filterComponents();
        }

        function updateTagFilterButtons() {
            const buttons = document.querySelectorAll('.tag-filter-btn');
            buttons.forEach(button => {
                const tag = button.textContent;
                if (selectedTags.has(tag)) {
                    button.style.cssText = `
                        padding: 0.25rem 0.75rem;
                        border: 2px solid #3b82f6;
                        background: #3b82f6;
                        color: white;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 0.875rem;
                        font-weight: 500;
                        transition: all 0.2s;
                    `;
                } else {
                    button.style.cssText = `
                        padding: 0.25rem 0.75rem;
                        border: 2px solid #d1d5db;
                        background: white;
                        color: #374151;
                        border-radius: 20px;
                        cursor: pointer;
                        font-size: 0.875rem;
                        font-weight: 500;
                        transition: all 0.2s;
                    `;
                }
            });
        }

        function filterComponents() {
            const components = document.querySelectorAll('.component-accordion');
            let visibleCount = 0;

            if (selectedTags.size === 0) {
                // Show all components if no tags selected
                components.forEach(component => {
                    component.style.display = 'block';
                    visibleCount++;
                });
            } else {
                components.forEach(component => {
                    const tagsAttr = component.getAttribute('data-component-tags');
                    if (tagsAttr) {
                        const componentTags = tagsAttr.split(',').map(tag => tag.trim()).filter(tag => tag);
                        // AND logic: component must have ALL selected tags
                        const hasAllSelectedTags = Array.from(selectedTags).every(selectedTag => componentTags.includes(selectedTag));
                        if (hasAllSelectedTags) {
                            component.style.display = 'block';
                            visibleCount++;
                        } else {
                            component.style.display = 'none';
                        }
                    } else {
                        component.style.display = 'none';
                    }
                });
            }

            updateComponentCounter(visibleCount, components.length);
        }

        function updateComponentCounter(visible, total) {
            const counter = document.getElementById('componentCounter');
            if (counter) {
                if (selectedTags.size === 0) {
                    counter.textContent = `${total} components`;
                } else {
                    counter.textContent = `${visible} of ${total} components`;
                }
            }
        }

        function clearTagFilters() {
            selectedTags.clear();
            updateTagFilterButtons();
            filterComponents();
        }

        function toggleDescription(componentId) {
            const preview = document.getElementById(`preview-${componentId}`);
            const full = document.getElementById(`desc-${componentId}`);

            if (full && preview) {
                if (full.style.display === 'none') {
                    full.style.display = 'block';
                    preview.style.display = 'none';
                } else {
                    full.style.display = 'none';
                    preview.style.display = 'block';
                }
            }
        }

        // Component editing functionality
        let currentEditComponentId = null;

        function showEditComponentModal(componentId, name, type, technology, description, tags) {
            console.log('Opening edit component modal for:', componentId);
            currentEditComponentId = componentId;

            document.getElementById('editComponentModal').classList.add('active');

            // Populate form fields
            document.getElementById('editComponentName').value = name || '';
            document.getElementById('editComponentType').value = type || '';
            document.getElementById('editComponentTechnology').value = technology || '';
            document.getElementById('editComponentTags').value = tags || '';
            document.getElementById('editComponentDescription').value = description || '';
        }

        function updateComponent() {
            if (!currentEditComponentId) {
                alert('Error: No component selected for editing');
                return;
            }

            const name = document.getElementById('editComponentName').value.trim();
            const type = document.getElementById('editComponentType').value;
            const technology = document.getElementById('editComponentTechnology').value.trim();
            const description = document.getElementById('editComponentDescription').value.trim();
            const tagsInput = document.getElementById('editComponentTags').value.trim();

            if (!name) {
                alert('Please enter a component name');
                return;
            }
            if (!type) {
                alert('Please select a component type');
                return;
            }

            // Parse tags from comma-separated string
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0) : [];

            const data = {
                id: currentEditComponentId,
                name: name,
                component_type: type,
                technology: technology || null,
                description: description || null,
                tags: tags
            };

            console.log('Updating component:', data);

            fetch('/api/components/update', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    console.log('Component updated successfully:', result);
                    closeModal('editComponentModal');
                    // Reload the page to show the updated component
                    window.location.reload();
                } else {
                    alert('Error updating component: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error updating component:', error);
                alert('Error updating component. Please try again.');
            });
        }

        // Debug logging
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, project data:', projectData);
            initializeTagFilters();
        });
    </script>
</body>
</html>